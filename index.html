<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DICOMTROL</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
  <style>
    html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

    /* --------- LOGIN --------- */
    #login-screen {
      min-height: 100vh;
      background: url("1172357-abstracto-blanco-rojo-vector-4K.jpg") no-repeat center center fixed;
      background-size: cover;
    }
    .login-box {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(6px);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .brand {
      font-size: 2rem;
      font-weight: 800;
      letter-spacing: 1.2px;
      color: #cc0000;
      text-align: center;
    }
    .brand span {
      color: #fff;
      background: #cc0000;
      padding: 0 8px;
      border-radius: 6px;
    }
    .logo-svg {
      width: 140px;
      height: auto;
      display: block;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.2));
    }
    .btn-red { background: #cc0000; transition: .2s; }
    .btn-red:hover { background: #990000; }

    /* --------- PANEL PRINCIPAL --------- */
    #main-panel {
      display: none;
      min-height: 100vh;
      background: url("abstract-background-red-on-white-vector.jpg") no-repeat center center fixed;
      background-size: cover;
      padding: 0;
    }
    .panel-card {
      background: rgba(255,255,255,0.96);
      backdrop-filter: blur(4px);
      border-radius: 0;
      box-shadow: none;
      padding: 24px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .titulo {
      font-size: 1.875rem; /* text-3xl */
      font-weight: 800;
      color: #b10000;
      letter-spacing: .5px;
      display: inline-flex; align-items: center; gap: .5rem;
      position: relative;
    }
    .titulo::after {
      content: "";
      position: absolute;
      left: 0; bottom: -6px;
      height: 4px; width: 55%;
      background: linear-gradient(90deg, #b10000, #ff5252);
      border-radius: 4px;
    }

    /* --------- TABLA --------- */
    .tabla-wrapper {
      flex-grow: 1;
      overflow: auto;
    }
    table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
    thead th {
      background: #b10000; color: #fff; text-align: center; padding: 12px;
      font-weight: 700;
    }
    tbody td { text-align: center; padding: 12px; border-bottom: 1px solid #eee; }
    tbody tr:nth-child(even) { background: #fafafa; }
    tbody tr:hover { background: #fff1f1; }

    /* --------- MODAL --------- */
    #modalImagenBackdrop { background: rgba(0,0,0,0.6); }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <section id="login-screen" class="flex items-center justify-center">
    <div class="login-box w-full max-w-sm p-8">
      <div class="mb-4 flex flex-col items-center">
        <!-- Logo -->
        <svg class="logo-svg mb-2" viewBox="0 0 360 90" xmlns="http://www.w3.org/2000/svg" aria-label="Logo DICOMTROL">
          <rect x="8" y="18" rx="18" ry="18" width="100" height="54" fill="#cc0000"/>
          <rect x="52" y="28" width="12" height="34" fill="#ffffff"/>
          <rect x="41" y="39" width="34" height="12" fill="#ffffff"/>
          <text x="124" y="56" font-size="30" font-weight="800" fill="#cc0000" font-family="Segoe UI, Tahoma, Verdana, sans-serif">DICOMTROL</text>
        </svg>
        <div class="brand"><span>DICOM</span>TROL</div>
      </div>

      <label class="block text-gray-700 font-medium">Usuario</label>
      <input id="username" class="w-full px-3 py-2 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="text" placeholder="admin" />

      <label class="block text-gray-700 font-medium">ContraseÃ±a</label>
      <input id="password" class="w-full px-3 py-2 mb-6 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="password" placeholder="clave123" />

      <button onclick="login()" class="w-full btn-red text-white py-2 rounded-lg shadow-md">Iniciar SesiÃ³n</button>
      <p id="loginError" class="text-red-600 text-center mt-4 hidden">Credenciales incorrectas</p>
    </div>
  </section>

  <!-- PANEL PRINCIPAL -->
  <section id="main-panel">
    <div class="panel-card">
      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
        <h2 class="titulo">ðŸ“‹ Lista de Estudios</h2>
        <div class="flex gap-2 w-full md:w-1/2">
          <input id="search" type="text" placeholder="Buscar por nombre, ID o fechaâ€¦" class="flex-1 px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" oninput="filtrar()" />
          <button class="px-4 py-2 rounded-lg border border-red-600 text-red-700 hover:bg-red-50" onclick="cargarEstudios()">Recargar</button>
        </div>
      </div>

      <!-- Tabla -->
      <div class="tabla-wrapper">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Fecha Estudio</th>
              <th>Fecha de Llegada</th>
              <th>Nacimiento</th>
              <th>DescripciÃ³n</th>
              <th>ID Paciente</th>
              <th>InstituciÃ³n</th>
              <th>Archivo</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaEstudios"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- MODAL IMAGEN -->
  <div id="modalImagen" class="hidden fixed inset-0 z-50">
    <div id="modalImagenBackdrop" class="absolute inset-0"></div>
    <div class="relative mx-auto my-8 bg-white max-w-5xl rounded-xl shadow-2xl overflow-hidden">
      <div class="flex justify-between items-center px-4 py-2 border-b">
        <div class="font-semibold text-red-700">Vista previa DICOM</div>
        <button onclick="cerrarModal()" class="px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cerrar</button>
      </div>
      <div class="p-4">
        <img id="imagenDicom" src="" alt="Imagen DICOM" class="w-full rounded-lg border" />
      </div>
    </div>
  </div>

  <script>
    const estudios = [];

    function formatFechaDicom(yyyymmdd) {
      if (!yyyymmdd) return "â€”";
      if (/^\d{8}$/.test(yyyymmdd)) {
        return `${yyyymmdd.slice(0,4)}-${yyyymmdd.slice(4,6)}-${yyyymmdd.slice(6,8)}`;
        }
      return yyyymmdd;
    }

    function formatLlegada(val) {
      if (!val) return "â€”";
      const d = new Date(val);
      if (!isNaN(d)) return d.toLocaleString();
      if (/^\d{8}$/.test(val)) return formatFechaDicom(val);
      return val;
    }

    async function login() {
      const usuario = document.getElementById("username").value;
      const clave = document.getElementById("password").value;
      if (usuario === "admin" && clave === "clave123") {
        document.getElementById("login-screen").style.display = "none";
        document.getElementById("main-panel").style.display = "block";
        await cargarEstudios();
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    async function cargarEstudios() {
      try {
        const res = await fetch("https://visor-dicom-backend.onrender.com/estudios");
        const data = await res.json();
        estudios.length = 0;
        estudios.push(...data);
        renderTabla(estudios);
      } catch (err) {
        alert("No se pudo cargar la lista de estudios");
      }
    }

    function renderTabla(list) {
      const tbody = document.getElementById("tablaEstudios");
      tbody.innerHTML = "";

      list.forEach(e => {
        const llegada = e.llegada || e.created_at || "";
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${e.nombre || "â€”"}</td>
          <td>${formatFechaDicom(e.fecha)}</td>
          <td>${formatLlegada(llegada) || "â€”"}</td>
          <td>${formatFechaDicom(e.nacimiento)}</td>
          <td>${e.descripcion || "â€”"}</td>
          <td>${e.paciente_id || "â€”"}</td>
          <td>${e.institucion || "â€”"}</td>
          <td title="${e.archivo || ""}">${e.archivo || "â€”"}</td>
          <td>
            <button class="px-3 py-1 rounded border border-blue-600 text-blue-700 hover:bg-blue-50"
                    onclick="verImagen('${e.archivo}')">
              Ver Imagen
            </button>
          </td>
        `;
        tbody.appendChild(fila);
      });
    }

    function filtrar() {
      const q = (document.getElementById("search").value || "").toLowerCase();
      const filtrados = estudios.filter(e =>
        (e.nombre || "").toLowerCase().includes(q) ||
        (e.paciente_id || "").toLowerCase().includes(q) ||
        (e.fecha || "").toLowerCase().includes(q)
      );
      renderTabla(filtrados);
    }

    function verImagen(nombreArchivo) {
      if (!nombreArchivo) return;
      const t = Date.now();
      const url = `https://visor-dicom-backend.onrender.com/imagen/${encodeURIComponent(nombreArchivo)}?t=${t}`;
      document.getElementById("imagenDicom").src = url;
      document.getElementById("modalImagen").classList.remove("hidden");
    }

    function cerrarModal() {
      document.getElementById("modalImagen").classList.add("hidden");
      document.getElementById("imagenDicom").src = "";
    }
  </script>
</body>
</html>
