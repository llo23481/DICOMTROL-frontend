<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DICOMTROL</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
<style>
html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

/* --------- LOGIN --------- */
#login-screen {
  min-height: 100vh;
  background: url("1172357-abstracto-blanco-rojo-vector-4K.jpg") no-repeat center center fixed;
  background-size: cover;
}
.login-box {
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  padding: 2rem;
  width: 100%;
  max-width: 400px;
}
.brand { font-size: 2rem; font-weight: 800; letter-spacing: 1.2px; color: #cc0000; text-align: center; }
.brand span { color: #fff; background: #cc0000; padding: 0 8px; border-radius: 6px; }
.logo-svg { width: 140px; height: auto; display: block; margin: 0 auto 12px; filter: drop-shadow(0 2px 4px rgba(0,0,0,.2)); }
.btn-red { background: #cc0000; transition: .2s; }
.btn-red:hover { background: #990000; }

/* --------- PANEL PRINCIPAL --------- */
#main-panel { display: none; min-height: 100vh; background: url("abstract-background-red-on-white-vector.jpg") no-repeat center center fixed; background-size: cover; padding: 0; overflow-y: auto; }
.panel-card { background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); padding: 24px; margin: 2rem; display: flex; flex-direction: column; }

/* TABLE SCROLL FLOATER */
.tabla-wrapper { flex-grow: 1; overflow-y: auto; max-height: calc(100vh - 200px); border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15); background: rgba(255,255,255,0.95); }
table { width: 100%; border-collapse: collapse; overflow: hidden; min-width: 1000px; }
thead th { background: #b10000; color: #fff; text-align: center; padding: 12px; font-weight: 700; position: sticky; top: 0; z-index: 2; }
tbody td { text-align: center; padding: 12px; border-bottom: 1px solid #eee; }
tbody tr:nth-child(even) { background: #fafafa; }
tbody tr:hover { background: #fff1f1; cursor: pointer; }

/* --------- MODALES --------- */
.modal-bg { background: rgba(0,0,0,0.6); }
.modal-card { background: white; border-radius: 1rem; padding: 1rem; max-width: 5xl; width: 100%; overflow-y: auto; max-height: 90vh; }

/* VISOR */
#visorModal .card { display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap; }
#visorModal img { max-width: 720px; max-height: 80vh; border-radius: 8px; }
#visorMeta { min-width: 320px; max-width: 420px; overflow:auto; }

/* SERIES SCROLL HORIZONTAL */
.series-scroll {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 8px 0;
  scroll-snap-type: x mandatory;
}
.series-item {
  flex: 0 0 auto;
  scroll-snap-align: start;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  overflow: hidden;
  width: 160px;
  height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #eee;
}
.series-item img {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
}

/* SERIES VERTICAL SCROLL */
#seriesContainer { max-height: 70vh; overflow-y: auto; }
</style>
</head>
<body>

<!-- LOGIN -->
<section id="login-screen" class="flex items-center justify-center">
  <div class="login-box">
    <div class="mb-4 flex flex-col items-center">
      </svg>
      <div class="brand"><span>DICOM</span>TROL</div>
    </div>

    <label class="block text-gray-700 font-medium">Usuario</label>
    <input id="username" class="w-full px-3 py-2 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="text" placeholder="admin" />

    <label class="block text-gray-700 font-medium">Contrase√±a</label>
    <input id="password" class="w-full px-3 py-2 mb-6 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="password" placeholder="clave123" />

    <button onclick="login()" class="w-full btn-red text-white py-2 rounded-lg shadow-md">Iniciar Sesi√≥n</button>
    <p id="loginError" class="text-red-600 text-center mt-4 hidden">Credenciales incorrectas</p>
  </div>
</section>

<!-- PANEL PRINCIPAL -->
<section id="main-panel">
  <div class="panel-card">
    <!-- HEADER -->
<div class="flex justify-between items-center mb-6">
  <div class="flex items-center gap-2">
    <div class="brand"><span>DICOM</span>TROL</div>
  </div>

  <div class="flex items-center gap-4">
    <!-- BOT√ìN EXPORTAR -->
    <button id="btnExportar" 
      class="flex items-center gap-2 px-6 py-3 
           bg-gradient-to-r from-red-600 via-red-500 to-red-700
           text-white font-semibold rounded-xl shadow-lg
           transform transition-all duration-300 ease-in-out
           hover:shadow-2xl hover:-translate-y-1 hover:scale-105
           active:translate-y-0 active:scale-100">
      üì©Exportar
    </button>

    <!-- BURBUJA USUARIO -->
    <div class="relative">
      <div class="flex items-center justify-center w-20 h-10 bg-red-600 rounded-full shadow-md">
      </div>
      <span class="absolute inset-0 flex items-center justify-center text-white font-semibold text-sm">
        admin
      </span>
    </div>
  </div>
</div>

<!-- POPUP EXPORTAR -->
<div id="popupExportar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-80">
    <h2 class="text-lg font-semibold mb-4 text-gray-800">Exportar estudios</h2>
    <p class="text-sm text-gray-600 mb-4">Selecciona el rango de tiempo que deseas exportar:</p>

    <div class="space-y-3">
      <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        onclick="exportarEstudios('hoy')">Hoy</button>
      <button class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
        onclick="exportarEstudios('semanal')">Semanal</button>
      <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
        onclick="exportarEstudios('mensual')">Mensual</button>
    </div>

    <div class="flex justify-end mt-4">
      <button onclick="cerrarPopup()" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">
        Cancelar
      </button>
    </div>
  </div>
</div>

<script>
  // Mostrar popup
  document.getElementById("btnExportar").addEventListener("click", () => {
    document.getElementById("popupExportar").classList.remove("hidden");
  });

  // Cerrar popup
  function cerrarPopup() {
    document.getElementById("popupExportar").classList.add("hidden");
  }

  // Llamada al backend
  async function exportarEstudios(rango) {
    try {
      const response = await fetch(`/exportar?rango=${rango}`, {
        method: "GET"
      });

      if (!response.ok) {
        throw new Error("Error al exportar los estudios");
      }

      // Descargar el archivo Excel
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `estudios_${rango}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      cerrarPopup();
    } catch (error) {
      alert("Hubo un problema: " + error.message);
    }
  }
</script>

 <!-- FILTROS Y BUSCADOR -->
    <div class="flex flex-col md:flex-row items-center gap-4 mb-4">
      <input id="search" type="text" placeholder="Buscar por nombre, ID o fecha‚Ä¶" class="flex-1 px-3 py-2 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" oninput="aplicarFiltros()">
      <select id="filterEstado" class="px-3 py-2 border rounded-lg shadow-sm" onchange="aplicarFiltros()">
        <option value="">Todos los Estados</option>
        <option value="Pendiente">Pendiente</option>
        <option value="Visto">Visto</option>
      </select>
      <select id="filterMedico" class="px-3 py-2 border rounded-lg shadow-sm" onchange="aplicarFiltros()">
        <option value="">Todos los M√©dicos</option>
      </select>
      <select id="filterNumImagenes" class="px-3 py-2 border rounded-lg shadow-sm" onchange="aplicarFiltros()">
        <option value="">Todas las cantidades</option>
        <option value="1">1 Imagen</option>
        <option value="2">2 Im√°genes</option>
        <option value="3">3 Im√°genes</option>
        <option value="4">4+</option>
      </select>
      <button onclick="cargarEstudios()" class="px-4 py-2 rounded-lg border border-red-600 text-red-700 hover:bg-red-50">Recargar</button>
    </div>

    <!-- TABLA -->
    <div class="tabla-wrapper overflow-auto flex-1">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Fecha Llegada</th>
            <th>Nacimiento</th>
            <th>Descripci√≥n</th>
            <th>ID Paciente</th>
            <th>Instituci√≥n</th>
            <th># Im√°genes</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaEstudios"></tbody>
      </table>
    </div>
  </div>
</section>

<!-- MODALES SERIES Y VISOR -->
<div id="modalSeries" class="hidden fixed inset-0 z-40 flex items-start justify-center modal-bg pt-20">
  <div class="modal-card relative max-w-6xl w-full">
    <button onclick="cerrarModalSeries()" class="absolute top-2 right-2 px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cerrar</button>
    <h2 class="text-xl font-bold text-red-700 mb-4">Series del Estudio</h2>
    <div id="seriesContainer" class="space-y-4"></div>
  </div>
</div>

<div id="visorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-6">
  <div class="modal-card relative max-w-7xl w-full">
    <button onclick="cerrarVisor()" class="absolute top-3 right-3 px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cerrar</button>
    <div class="card p-4 flex flex-col md:flex-row gap-4">
      <div id="visorImageContainer" class="flex-1 flex items-center justify-center">
        <img id="visorImage" src="" alt="Imagen grande"/>
      </div>
      <div id="visorMeta" class="p-4 border-l">
        <h3 id="metaNombre" class="font-bold text-lg text-red-700 mb-2"></h3>
        <div id="metaBody"></div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://visor-dicom-backend.onrender.com";
let estudios = [];
let estudiosFiltrados = [];

function formatFecha(fechaStr){
  if(!fechaStr) return "";
  const f=new Date(fechaStr);
  const dia=("0"+f.getDate()).slice(-2);
  const mes=("0"+(f.getMonth()+1)).slice(-2);
  const anio=f.getFullYear();
  const h=("0"+f.getHours()).slice(-2);
  const m=("0"+f.getMinutes()).slice(-2);
  return `${dia}-${mes}-${anio} - ${h}:${m}`;
}

function formatNacimiento(fechaStr){
  if(!fechaStr) return "";
  const f=new Date(fechaStr);
  const anio=f.getFullYear();
  const mes=("0"+(f.getMonth()+1)).slice(-2);
  const dia=("0"+f.getDate()).slice(-2);
  return `${anio}-${mes}-${dia}`;
}

async function login() {
  const usuario = document.getElementById("username").value;
  const clave = document.getElementById("password").value;
  if(usuario==="admin" && clave==="clave123"){
    document.getElementById("login-screen").style.display="none";
    document.getElementById("main-panel").style.display="block";
    await cargarEstudios();
  }else{
    document.getElementById("loginError").classList.remove("hidden");
  }
}

async function cargarEstudios(){
  try{
    const res = await fetch(`${API_BASE}/estudios`);
    if(!res.ok) throw new Error("error al obtener estudios");
    const data = await res.json();
    estudios.length=0;
    estudios.push(...data);
    actualizarFiltros();
    aplicarFiltros();
  }catch(err){
    alert("No se pudo cargar los estudios");
    console.error(err);
  }
}

function actualizarFiltros(){
  const medicoSet = new Set(estudios.map(e=>e.medico_remitente).filter(Boolean));
  const medicoSelect = document.getElementById("filterMedico");
  medicoSelect.innerHTML='<option value="">Todos los M√©dicos</option>';
  medicoSet.forEach(m=>{
    const opt=document.createElement("option");
    opt.value=m; opt.textContent=m; medicoSelect.appendChild(opt);
  });
}

function aplicarFiltros(){
  const q=(document.getElementById("search").value||"").toLowerCase();
  const estado=document.getElementById("filterEstado").value;
  const medico=document.getElementById("filterMedico").value;
  const numImg=document.getElementById("filterNumImagenes").value;

  estudiosFiltrados = estudios.filter(e=>{
    let match=true;
    if(q && !( (e.nombre||"").toLowerCase().includes(q) || (e.paciente_id||"").toLowerCase().includes(q) || (e.fecha||"").toLowerCase().includes(q) )) match=false;
    if(estado && e.estado!==estado) match=false;
    if(medico && e.medico_remitente!==medico) match=false;
    if(numImg){
      if(numImg==="4" && e.num_imagenes<4) match=false;
      else if(numImg!=="4" && e.num_imagenes!=parseInt(numImg)) match=false;
    }
    return match;
  });
  renderTabla();
}

function renderTabla(){
  const tbody=document.getElementById("tablaEstudios");
  tbody.innerHTML="";
  estudiosFiltrados.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.nombre||""}</td>
      <td>${formatFecha(e.created_at)}</td>
      <td>${formatNacimiento(e.nacimiento)}</td>
      <td>${e.descripcion||""}</td>
      <td>${e.paciente_id||""}</td>
      <td>${e.institucion||""}</td>
      <td>${e.num_imagenes||0}</td>
      <td>${e.estado||""}</td>
      <td><button onclick="abrirModalSeries(${e.id})" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Ver</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// abrir modal series con scroll horizontal
async function abrirModalSeries(estudioId){
  const modal=document.getElementById("modalSeries");
  const cont=document.getElementById("seriesContainer");
  cont.innerHTML="Cargando series...";
  modal.classList.remove("hidden");

  try{
    const res=await fetch(`${API_BASE}/estudios/${estudioId}/series`);
    if(!res.ok) throw new Error("no series");
    const series = await res.json();
    cont.innerHTML="";
    for(const s of series){
      const div=document.createElement("div");
      div.className="border p-2 rounded";
      div.innerHTML=`<h3 class="font-semibold text-red-600 mb-2">${s.series_description||s.modality||"Serie"}</h3>
      <div id="imagenes_${s.id}" class="series-scroll"></div>`;
      cont.appendChild(div);
      cargarImagenesSerie(s.id, estudioId, s);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las series";
    console.error(err);
  }
}

function cerrarModalSeries(){
  document.getElementById("modalSeries").classList.add("hidden");
}

async function cargarImagenesSerie(serieId, estudioId, serieObj){
  const cont=document.getElementById(`imagenes_${serieId}`);
  cont.innerHTML="Cargando im√°genes...";
  try{
    const res=await fetch(`${API_BASE}/series/${serieId}/imagenes`);
    if(!res.ok) throw new Error("no imagenes");
    const imagenes = await res.json();
    cont.innerHTML="";
    for(const img of imagenes){
      const imgElem=document.createElement("div");
      imgElem.className="series-item";
      const src = img.preview_base64 ? `data:image/png;base64,${img.preview_base64}` : `${API_BASE}/imagen/${img.id}?frame=0`;
      imgElem.innerHTML=`<img id="img_${img.id}" src="${src}" onclick="abrirVisor(${img.id}, ${estudioId}, ${serieId})"/>`;
      cont.appendChild(imgElem);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las im√°genes";
    console.error(err);
  }
}

async function abrirVisor(imagenId, estudioId, serieId){
  try{
    const visorImg = document.getElementById("visorImage");
    visorImg.src = `${API_BASE}/imagen/${imagenId}`;

    const resEst = await fetch(`${API_BASE}/estudios/${estudioId}`);
    const est = resEst.ok ? await resEst.json() : null;
    const resSer = await fetch(`${API_BASE}/series/${serieId}`);
    const ser = resSer.ok ? await resSer.json() : null;

    document.getElementById("metaNombre").textContent = est?.nombre || "Estudio";
    const metaBody = document.getElementById("metaBody");
    metaBody.innerHTML = `
      <p><strong>ID Estudio:</strong> ${est?.id||""}</p>
      <p><strong>Patient ID:</strong> ${est?.paciente_id||""}</p>
      <p><strong>Fecha Nac.:</strong> ${est?.nacimiento||""}</p>
      <p><strong>Fecha Estudio:</strong> ${formatFecha(est?.fecha)}</p>
      <p><strong>Fecha Llegada:</strong> ${formatFecha(est?.created_at)}</p>
      <p><strong>Instituci√≥n:</strong> ${est?.institucion||""}</p>
      <hr class="my-2"/>
      <p><strong>Serie:</strong> ${ser?.series_description||ser?.modality||""}</p>
      <p><strong>Parte cuerpo:</strong> ${ser?.body_part||""}</p>
      <p><strong>M√©dico remitente:</strong> ${ser?.medico_remitente||""}</p>
    `;
    document.getElementById("visorModal").classList.remove("hidden");
  }catch(err){
    alert("No se pudo abrir visor");
    console.error(err);
  }
}

function cerrarVisor(){
  document.getElementById("visorModal").classList.add("hidden");
  document.getElementById("visorImage").src = "";
}
</script>
</body>
</html>
