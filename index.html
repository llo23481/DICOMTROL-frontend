<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DICOMTROL</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
<style>
html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

#login-screen {
  min-height: 100vh;
  background: url("abstract-health-medical-science-healthcare-icon-digital-technology-science-concept-modern-innovation-treatment-medicine-on-hi-tech-future-blue-background-for-wallpaper-template-web-design-vector.jpg") no-repeat center center fixed;
  background-size: cover;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  animation: fadeIn 0.6s forwards;
}

.login-box {
  background: rgba(255, 255, 255, 0.45); /* m√°s transparente */
  backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  padding: 2rem;
  width: 100%;
  max-width: 400px;
  transition: opacity 0.4s, transform 0.4s;
}

/* Logo DICOMTROL como texto */
.brand { 
  font-size: 2.0rem; 
  font-weight: 700; 
  letter-spacing: 1.2px; 
  color: #003366; /* azul oscuro */
  text-align: center; 
}
.brand span { 
  color: #fff; 
  background: #003366; 
  padding: 0 8px; 
  border-radius: 6px; 
}

/* Inputs estilo */
.login-box input {
  width: 100%;
  padding: 0.6rem 0.8rem;
  margin-bottom: 1rem;
  border: 2px solid rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.login-box input:focus {
  outline: none;
  border-color: #003366; /* azul al enfocar */
  box-shadow: 0 0 8px rgba(0,51,102,0.5);
}

/* Fade Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-15px); }
}

#login-screen.fade-out {
  animation: fadeOut 0.5s forwards;
}

/* Bot√≥n */
.btn-red { background: #003366; transition: .2s; }
.btn-red:hover { background: #002244; }

/* --------- PANEL PRINCIPAL --------- */
#main-panel {
  min-height: 100vh;
  background: rgba(255,255,255,0.85)
    url("abstract-technology-science-concept-dna-futuristic-on-hi-tech-blue-background-vector.webp")
    no-repeat center center fixed;
  background-size: cover;
  display: flex;
  flex-direction: column;
  opacity: 1;
  transition: opacity 0.4s ease-in-out;
}

#main-panel.visible {
  opacity: 1;
}

/* --------- TARJETAS (PANEL-CARD) --------- */
#main-panel {
  min-height: 100vh;
  background: rgba(255,255,255,0.08)
    url("abstract-technology-science-concept-dna-futuristic-on-hi-tech-blue-background-vector.webp")
    no-repeat center center fixed;
  background-size: cover;
  display: flex;
  flex-direction: column;
  opacity: 1;
  transition: opacity 0.6s ease-in-out;
}

#main-panel.visible {
  opacity: 1;
}

/* --------- TARJETAS (PANEL-CARD) --------- */
.panel-card {
  position: relative;
  background: rgba(255,255,255,0.28);
  backdrop-filter: blur(4px) saturate(120%);
  border-radius: 12px;
  border: 1px solid rgba(0,180,255,0.4);
  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
  padding: 24px;
  margin: 2rem;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: all 0.2s ease;
}

/* Hover flotante */
.panel-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 5px 18px rgba(0,200,255,0.3);
}

/* --------- ANIMACI√ìN DE BRILLO ENERG√âTICO --------- */
.panel-card::before {
  content: "";
  position: absolute;
  top: -3px;
  left: -3px;
  width: calc(100% + 6px);
  height: calc(100% + 6px);
  border-radius: 18px;
  background: linear-gradient(
    120deg,
    rgba(0,200,255,0.9),
    rgba(255,255,255,0.6),
    rgba(0,180,255,0.9)
  );
  background-size: 300% 300%;
  z-index: 1;
  opacity: 0.55;
  animation: bordeBrillante 3s linear infinite;
  filter: blur(1px);
  pointer-events: none;
}

@keyframes bordeBrillante {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Capa superior del contenido */
.panel-card > * {
  position: relative;
  z-index: 2;
}
/* --------- EFECTO DE ENCENDIDO AL MOSTRAR EL PANEL --------- */
#main-panel.visible::after {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, rgba(0,200,255,0.4), transparent 70%);
  pointer-events: none;
  opacity: 0;
  animation: encendidoBrillo 2.5s ease-out forwards;
  z-index: 100;
}

@keyframes encendidoBrillo {
  0% {
    opacity: 0.9;
    transform: scale(1.2);
    filter: blur(10px);
  }
  40% {
    opacity: 1;
    transform: scale(1);
    filter: blur(4px);
  }
  100% {
    opacity: 0;
    transform: scale(1);
    filter: blur(0);
  }
}
/* TABLE SCROLL FLOATER */
/* ====== TABLA PRINCIPAL (con contraste visual) ====== */
.tabla-wrapper {
  flex-grow: 1;
  overflow-y: auto;
  max-height: calc(100vh - 200px);
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.22);
  backdrop-filter: blur(3px);
  box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

table {
  width: 100%;
  border-collapse: collapse;
  overflow: hidden;
  min-width: 1000px;
  color: #fff;
  font-size: 0.95rem;
  letter-spacing: 0.3px;
}

/* Cabecera azul s√≥lida */
thead th {
  background: rgba(0, 34, 68, 0.88);
  color: #eaf6ff;
  text-align: center;
  padding: 14px;
  font-weight: 600;
  text-shadow: 0 0 4px rgba(0, 180, 255, 0.3);
  position: sticky;
  top: 0;
  z-index: 2;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
thead th:hover {
  background: rgba(0, 60, 120, 0.9);
  transform: scale(1.03);
}
/* Filas simples sin hover ni efectos */
tbody td {
  text-align: center;
  padding: 12px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.05);
  color: #111;
  background: rgba(255, 255, 255, 0.9);
}

/* Alternancia ligera */
tbody tr:nth-child(even) td {
  background: rgba(250, 250, 250, 0.95);
}

tbody tr:hover td {
  background: rgba(0, 123, 255, 0.15);
  color: #000;
  cursor: pointer;
  transform: scale(1.01);
  transition: all 0.25s ease;
}

/* Botones de paginaci√≥n limpios */
#btnPrev, #btnNext {
  background: rgba(0, 123, 255, 0.2);
  color: #003366;
  border: 1px solid rgba(0, 123, 255, 0.4);
  border-radius: 8px;
  padding: 8px 14px;
  font-weight: 500;
  cursor: pointer;
}

#btnPrev:hover, #btnNext:hover {
  background: rgba(0, 123, 255, 0.35);
}

/* --------- MODALES CON TRANSPARENCIA --------- */
.modal-bg { 
  background: rgba(0,0,0,0.55); 
  backdrop-filter: blur(6px); 
}
.modal-card { 
  background: rgba(255,255,255,0.86); 
  backdrop-filter: blur(10px); 
  border-radius: 1rem; 
  padding: 1rem; 
  max-width: 90%; 
  width: 100%; 
  overflow-y: auto; 
  max-height: 90vh; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.25); 
}

/* VISOR */
#visorModal .card { display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap; }
#visorModal img { max-width: 720px; max-height: 80vh; border-radius: 8px; }
#visorMeta { min-width: 320px; max-width: 420px; overflow:auto; }

/* SERIES SCROLL HORIZONTAL */
.series-scroll {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 8px 0;
  scroll-snap-type: x mandatory;
}
.series-item {
  flex: 0 0 auto;
  scroll-snap-align: start;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  overflow: hidden;
  width: 160px;
  height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #eee;
}
.series-item img {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
}

/* SERIES VERTICAL SCROLL (contenedor de series) */
#seriesContainer { max-height: 70vh; overflow-y: auto; padding-right: 8px; }

/* Bot√≥n Exportar peque√±o junto a la burbuja de usuario */
.btn-export-small {
  height: 40px;
  padding-left: 10px;
  padding-right: 12px;
  font-size: 0.875rem;
  border-radius: 9999px;
}

/* -------- VISOR DICOM (EVO style mejorado) -------- */
#dicomViewerModal { z-index: 70; }
#dicomViewerCard {
  max-width: 90vw;
  height: 95vh;
  background: rgba(0,34,66,0.74);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  position: relative;
  margin: 0 auto;
}

#dicomViewerCard.expanded {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  max-width: none;
  border-radius: 0;
  padding: 18px;
}
#dicomViewerCard .area {
  display:flex; flex:1; gap:12px; min-height:0;
}
#dicomCanvas {
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#001f3f;
  border-radius:8px;
  position:relative;
  overflow:hidden;
}

/* wrapper (transform applied here so overlay sigue alineada) */
#dicomImageWrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display:flex;
  align-items:center;
  justify-content:center;
  transform-origin:center center;
}

/* imagen */
#dicomViewerImage {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 10px;
  animation: zoomIn 1s ease;
  transition: all 0.3s ease;
  border: 3px solid transparent;
  box-shadow: 0 0 30px rgba(0, 0, 0, 0.6);
}

/* === Imagen seleccionada (borde azul y pulso) === */
#dicomViewerImage.active {
  border-color: #00aaff;
  box-shadow: 0 0 30px #007bff;
  animation: pulseBlue 1s infinite alternate;
}
@keyframes pulseBlue {
  from { box-shadow: 0 0 15px #007bff; }
  to { box-shadow: 0 0 30px #00ccff; }
}

/* overlay svg para medidas */
#overlaySvg {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  pointer-events:auto;
}

/* sidebar de metadata: fondo negro y letras azules */
#dicomInfoPanel {
  width: 300px;
  background: rgba(0,0,0,0.95);
  color: #3399ff;
  padding: 14px;
  border-radius: 8px;
  overflow-y:auto;
}
#dicomInfoPanel h3 { color: #66ccff; }

/* botones de herramientas circulares */
.tool-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(0,51,102,0.95);
  color: white;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
}
.tool-btn:hover { transform: scale(1.05); }

/* controles inferiores y navegaci√≥n */
.viewer-controls {
  position:absolute;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
}
.viewer-nav {
  position:absolute;
  bottom:18px;
  right:18px;
  display:flex;
  gap:10px;
}

/* visual styles for measurements */
.measure-line { stroke: #00ccff; stroke-width: 3; stroke-linecap:round; }
.measure-dot { fill:#00ccff; stroke:#000; stroke-width:1; r:4; }
.measure-text { fill:#00ccff; font-size:14px; font-weight:700; text-shadow:0 1px 3px rgba(0,0,0,0.6); }

/* responsive tweaks */
@media (max-width: 900px){
  #dicomViewerCard { max-width: 98vw; height: 92vh; }
  #dicomInfoPanel { width: 220px; }
}

#miniaturasSerie {
  background-color: #001f3f;
  padding: 5px;
  overflow-y: auto;
  height: 100%;
}

.miniatura-item {
  margin-bottom: 5px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: border 0.2s;
}

.miniatura-item img {
  display: block;
  width: 100%;
  object-fit: cover;
}

.miniatura-item.active {
  border: 2px solid #003366;
}
.fila-expandida td {
  background: #fff;
  padding: 0;
  border: none;
}

.panel-opciones {
  padding: 10px;
  background: white;
  border: 1px solid #003366;
  border-left: 5px solid #003366;
  border-radius: 4px;
  animation: slideDown 0.3s ease;
}

.panel-opciones div {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.panel-opciones .btn-icon {
  background: #003366;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.2s;
}

.panel-opciones .btn-icon:hover {
  background: #002244;
}

@keyframes expandSlide {
  from {
    opacity: 0;
    transform: translateX(-15px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
@keyframes slideDown {
  from { transform: scaleY(0); opacity: 0; }
  to { transform: scaleY(1); opacity: 1; }
}
/* ====== CONTENEDOR DE FILTROS ====== */
.filtros-container {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 14px 18px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ====== CAMPOS ====== */
.filtro-input, .filtro-select {
  background: rgba(255, 255, 255, 0.65);
  color: #002244;
  border: 1px solid rgba(0,0,0,0.15);
  padding: 10px 14px;
  border-radius: 8px;
  transition: all 0.3s ease;
  backdrop-filter: blur(6px);
  font-size: 0.95rem;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
}

.filtro-input::placeholder {
  color: rgba(0,0,0,0.5);
}

.filtro-input:focus, .filtro-select:focus {
  border-color: #007BFF;
  box-shadow: 0 0 10px rgba(0,123,255,0.4);
  outline: none;
  background: rgba(255,255,255,0.9);
  color: #001933;
}

/* Estilo para inputs de fecha */
.filtro-input-date {
  background: rgba(255, 255, 255, 0.65);
  color: #002244;
  border: 1px solid rgba(0,0,0,0.15);
  padding: 8px 12px;
  border-radius: 8px;
  font-size: 0.9rem;
  backdrop-filter: blur(6px);
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
  width: 140px;
}
.filtro-input-date:focus {
  outline: none;
  border-color: #007BFF;
  box-shadow: 0 0 10px rgba(0,123,255,0.4);
  background: rgba(255,255,255,0.9);
  color: #001933;
}
/* Animaci√≥n suave al aparecer el calendario (fallback visual) */
.filtro-input-date::-webkit-calendar-picker-indicator {
  opacity: 0.8;
  cursor: pointer;
  transition: opacity 0.2s;
}
.filtro-input-date:hover::-webkit-calendar-picker-indicator {
  opacity: 1;
}

/* ====== BOT√ìN RECARGAR ====== */
.btn-filtro {
  background: rgba(0,123,255,0.25);
  color: #fff;
  border: 1px solid rgba(0,123,255,0.6);
  border-radius: 10px;
  padding: 11px 20px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  backdrop-filter: blur(8px);
  letter-spacing: 0.3px;
  text-shadow: 0 0 4px rgba(255,255,255,0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-filtro:hover {
  background: rgba(0,123,255,0.4);
  box-shadow: 0 0 14px rgba(0,123,255,0.7);
  transform: scale(1.07);
}

.btn-filtro:active {
  transform: scale(0.97);
  box-shadow: 0 0 6px rgba(0,123,255,0.4);
}

/* ====== ICONO DE RECARGAR ANIMADO ====== */
.icono-recargar {
  display: inline-block;
  transition: transform 0.4s ease;
}

.btn-filtro:hover .icono-recargar {
  transform: rotate(360deg);
}
.loader {
  border: 5px solid rgba(255,255,255,0.2);
  border-top: 5px solid #007bff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  100% { transform: rotate(360deg); }
}

/* Estilo base para badges de estado */
.badge-estado {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 600;
  text-align: center;
  min-width: 80px;
  background-color: #1e3a8a; /* Azul oscuro */
  color: white;
  border: 1px solid #1e40af;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

/* Opcional: hover efecto suave */
.badge-estado:hover {
  opacity: 0.95;
}

/* Estilo base para botones con im√°genes */
.btn-accion {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  border: 1px solid transparent;
  background-size: 70%;
  background-position: center;
  background-repeat: no-repeat;
}

/* Bot√≥n Ver (Ojo Azul Oscuro) */
.btn-ver {
  background-color: #003366; /* Azul oscuro */
  color: white;
}
.btn-ver:hover {
  background-color: #002244;
  transform: scale(1.1);
  box-shadow: 0 0 12px rgba(0, 51, 102, 0.5);
}

/* Bot√≥n Reportes (Archivo Naranja) */
.btn-reportes {
  background-color: #f59e0b;
  color: white;
}
.btn-reportes:hover {
  background-color: #ea580c;
  transform: scale(1.1);
  box-shadow: 0 0 12px rgba(234, 88, 12, 0.5);
}

/* Bot√≥n Audios (Nota Musical Roja) */
.btn-audios {
  background-color: #dc2626;
  color: white;
}
.btn-audios:hover {
  background-color: #b91c1c;
  transform: scale(1.1);
  box-shadow: 0 0 12px rgba(185, 28, 28, 0.5);
}
/* Asegurar que los botones dentro de .acciones-col sean inline */
.acciones-col .btn-accion {
  display: inline-flex !important;
  margin: 0 !important;
}
.btn-accion img {
  width: 24px;
  height: 24px;
  object-fit: contain;
}

.btn-ver {
  background: rgba(0, 123, 255, 0.2); /* azul transparente */
  color: white;
  border: 1px solid rgba(0, 123, 255, 0.5);
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-ver:hover {
  background: rgba(0, 123, 255, 0.4); /* m√°s azul al pasar el cursor */
  box-shadow: 0 0 12px rgba(0, 123, 255, 0.6); /* brillo suave */
  transform: scale(1.05); /* crece un poco */
}
@keyframes brillarAzul {
  0% { box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); }
  50% { box-shadow: 0 0 15px rgba(0, 123, 255, 0.8); }
  100% { box-shadow: 0 0 5px rgba(0, 123, 255, 0.4); }
}

.btn-ver:hover {
  background: rgba(0, 123, 255, 0.4);
  animation: brillarAzul 1.2s infinite ease-in-out;
  transform: scale(1.05);
}
/* ======== VISOR DICOM AZUL/NEGRO ======== */
.modal-bg {
  background: rgba(0, 0, 20, 0.8);
  backdrop-filter: blur(10px);
  animation: fadeIn 0.5s ease-in-out;
}

/* ----- Tarjetas dentro del modal ----- */
.modal-card {
  background: rgba(10, 20, 40, 0.9);
  border-radius: 16px;
  border: 1px solid rgba(0, 150, 255, 0.25);
  box-shadow: 0 0 25px rgba(0, 150, 255, 0.15);
  color: #e0f7ff;
  padding: 1.5rem;
  animation: slideUp 0.4s ease;
}

/* ----- T√≠tulos ----- */
.modal-card h2, .modal-card h3 {
  color: #00b7ff;
  text-shadow: 0 0 8px rgba(0, 183, 255, 0.6);
}

/* ----- Botones generales ----- */
button {
  transition: all 0.25s ease;
}

/* ----- Botones normales ----- */
button:hover {
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(0, 150, 255, 0.6);
}

/* ----- Botones rojos ----- */
.bg-red-600 {
  background: linear-gradient(145deg, #b00000, #ff3b3b);
  box-shadow: 0 0 10px rgba(255, 50, 50, 0.4);
}

.bg-red-600:hover {
  background: linear-gradient(145deg, #ff3b3b, #b00000);
  box-shadow: 0 0 18px rgba(255, 100, 100, 0.6);
}

/* ----- Botones grises (cerrar modal peque√±o) ----- */
.bg-gray-600 {
  background: rgba(40, 40, 60, 0.8);
  border: 1px solid rgba(100, 150, 255, 0.2);
}

.bg-gray-600:hover {
  background: rgba(60, 80, 120, 0.9);
  box-shadow: 0 0 12px rgba(0, 150, 255, 0.6);
}

/* ----- Contenedor principal del visor ----- */
#dicomViewerCard {
  background: rgba(10, 20, 40, 0.95);
  border-radius: 16px;
  border: 1px solid rgba(0, 150, 255, 0.25);
  box-shadow: 0 0 25px rgba(0, 150, 255, 0.25);
  padding: 1rem;
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* ----- Miniaturas verticales ----- */
#miniaturasSerie {
  background: rgba(0, 0, 30, 0.8);
  border-right: 1px solid rgba(0, 150, 255, 0.15);
  padding: 8px;
  border-radius: 8px;
}

#miniaturasSerie img:hover {
  box-shadow: 0 0 12px rgba(0, 150, 255, 0.8);
  transform: scale(1.05);
}

/* ----- Informaci√≥n lateral ----- */
#dicomInfoPanel {
  background: rgba(15, 25, 40, 0.9);
  padding: 1rem;
  border-radius: 10px;
  border: 1px solid rgba(0, 150, 255, 0.2);
  color: #d0eaff;
}

/* ----- Botones de herramientas ----- */
.tool-btn {
  background: rgba(20, 40, 80, 0.8);
  color: #00b7ff;
  border: 1px solid rgba(0, 150, 255, 0.3);
  border-radius: 8px;
  padding: 8px 10px;
  margin: 0 5px;
}

.tool-btn:hover {
  background: rgba(0, 123, 255, 0.3);
  box-shadow: 0 0 10px rgba(0, 123, 255, 0.6);
}

/* ----- Animaciones ----- */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
<!-- VISOR DICOM ESTILO AZUL/NEGRO -->
<div id="dicomViewerModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg p-6">
  <div id="dicomViewerCard" class="relative bg-black rounded-xl shadow-2xl overflow-hidden">

   <div class="absolute top-4 left-[4.5rem] z-40 bg-gradient-to-r from-[#0a0f1a]/90 to-[#0f172a]/90 backdrop-blur-xl border border-blue-500/40 shadow-[0_0_20px_rgba(59,130,246,0.3)] rounded-full px-6 py-2 flex gap-3 transition-all duration-300 hover:shadow-[0_0_30px_rgba(59,130,246,0.6)]">
  <button class="tool-btn-modern" onclick="activateTool('Zoom')" title="Zoom">üîç</button>
  <button class="tool-btn-modern" onclick="activateTool('Pan')" title="Pan">‚úã</button>
  <button class="tool-btn-modern" onclick="activateTool('Wwwc')" title="Brillo/Contraste">‚òÄÔ∏è</button>
  <button class="tool-btn-modern" onclick="activateTool('Length')" title="Medir distancia">üìè</button>
  <button class="tool-btn-modern" onclick="activateTool('Area')" title="Medir √°rea">‚¨õ</button>
  <button class="tool-btn-modern" onclick="resetView()" title="Reset">‚Ü∫</button>
</div>

    <!-- Botones expandir / cerrar -->
    <div style="position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:30;">
      <button id="expandBtn" onclick="toggleExpandViewer()" title="Expandir/Restaurar" class="w-10 h-10 rounded-full bg-gray-700 text-white 
      <button onclick="cerrarModalViewer()" title="Cerrar" class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center hover:bg-red-700 transition">‚úï</button>
    </div>

    <!-- √Årea principal -->
    <div class="flex h-[80vh] w-[90vw]">
      <!-- Miniaturas -->
      <div id="miniaturasSerie" class="flex flex-col gap-2 overflow-y-auto bg-gray-950/70 p-3" style="width: 100px;">
        <!-- Miniaturas se cargan din√°micamente -->
      </div>

      <!-- Imagen principal -->
      <div id="dicomCanvas" class="flex-1 flex items-center justify-center bg-black relative">
        <div id="dicomImageWrapper" class="transition-all duration-600">
          <img id="dicomViewerImage" src="https://via.placeholder.com/1200x900?text=DICOM" 
               alt="DICOM" draggable="false" class="rounded-lg shadow-lg cursor-pointer transition-all duration-600"/>
          <svg id="overlaySvg" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
      </div>
    </div>

<style>
/* Estilo para inputs de fecha minimalistas */
.filtros-container input[type="date"] {
  padding: 0;
  font-size: 0.85rem;
  height: 24px;
  line-height: 24px;
}

/* Ocultar el texto de fecha, pero mantener funcionalidad */
.filtros-container input[type="date"]::-webkit-calendar-picker-indicator {
  opacity: 0.8;
  cursor: pointer;
  transition: opacity 0.2s;
}
.filtros-container input[type="date"]:hover::-webkit-calendar-picker-indicator {
  opacity: 1;
}

/* Para Firefox: ocultar el texto si no se ha seleccionado fecha */
.filtros-container input[type="date"]::placeholder {
  color: transparent;
}

/* Mostrar texto al hacer hover o foco */
.filtros-container input[type="date"]:focus,
.filtros-container input[type="date"]:hover {
  color: #333 !important;
}
.tool-btn-modern {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: linear-gradient(145deg, #0f172a, #1e293b);
  color: #60a5fa;
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 0 10px rgba(37, 99, 235, 0.3);
  border: 1px solid rgba(59, 130, 246, 0.4);
  transition: all 0.25s ease;
}

.tool-btn-modern:hover {
  background: linear-gradient(145deg, #1e3a8a, #2563eb);
  color: #fff;
  box-shadow: 0 0 20px rgba(59, 130, 246, 0.8);
  transform: scale(1.15);
}

.tool-btn-modern:active {
  transform: scale(1.05);
  box-shadow: 0 0 10px rgba(96, 165, 250, 0.7);
}
.tool-btn {
  @apply w-10 h-10 rounded-full bg-gray-700 text-white flex items-center justify-center hover:bg-blue-600 transition;
}
.nav-btn {
  @apply w-12 h-12 rounded-full text-white flex items-center justify-center text-2xl transition;
}

/* Miniaturas */
#miniaturasSerie img {
  width: 85px;
  height: 85px;
  object-fit: cover;
  border: 2px solid transparent;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}
#miniaturasSerie img:hover {
  border-color: #3b82f6;
  box-shadow: 0 0 10px #3b82f6aa;
}
#miniaturasSerie img.active {
  border-color: #3b82f6;
  box-shadow: 0 0 20px #3b82f6;
}

/* Imagen activa (resaltada) */
#dicomViewerImage.active {
  border-color: #00aaff;
  box-shadow: 0 0 30px #007bff;
  animation: pulseBlue 1s infinite alternate;
}
@keyframes pulseBlue {
  from { box-shadow: 0 0 15px #007bff; }
  to { box-shadow: 0 0 30px #00ccff; }
}
#dicomViewerModal {
  background: rgba(0, 0, 0, 0.98) !important;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 9999;
}

#dicomCanvas {
  background-color: black !important;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.viewer-controls {
  position: absolute;
  top: 12px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 10px;
  z-index: 50;
}

.tool-btn {
  background: #1e1e1e;
  color: #fff;
  border: 1px solid #444;
  border-radius: 50%;
  width: 42px;
  height: 42px;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background 0.2s, transform 0.1s;
}

.tool-btn:hover {
  background: #00bfff;
  transform: scale(1.1);
}

#miniaturasSerie img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  cursor: pointer;
  border: 2px solid transparent;
  border-radius: 4px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

#miniaturasSerie img.active {
  border-color: #00bfff;
  box-shadow: 0 0 10px #00bfff;
}

#dicomViewerImage.active {
  outline: 3px solid #00bfff;
  outline-offset: 4px;
  border-radius: 6px;
  transition: outline 0.2s;
}
#dicomViewerModal {
  background-color: black;
  color: white;
}

#dicomViewerImage {
  max-width: 90vw;
  max-height: 90vh;
  transition: outline 0.2s;
}

#dicomViewerImage.active {
  outline: 3px solid #00bfff;
  outline-offset: 3px;
  border-radius: 6px;
}

.tool-btn {
  background: #1e1e1e;
  color: white;
  border: 1px solid #333;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.tool-btn:hover {
  background: #007bff;
  transform: scale(1.1);
  box-shadow: 0 0 10px #00bfff;
}

#miniaturasSerie img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  cursor: pointer;
  border-radius: 6px;
  border: 2px solid transparent;
  transition: all 0.2s ease;
}

#miniaturasSerie img.active {
  border-color: #00bfff;
  box-shadow: 0 0 10px #00bfff;
}
/* === Animaci√≥n de zoom suave al cargar imagen === */
@keyframes zoomIn {
  from { transform: scale(0.97); opacity: 0; }
  to { transform: scale(1); opacity: 1; }
}
/* === Barra lateral de miniaturas con efectos === */
#miniaturasSerie {
  width: 110px;
  max-height: 95%;
  background: linear-gradient(180deg, rgba(10, 20, 40, 0.95), rgba(5, 10, 25, 0.98));
  border-right: 2px solid rgba(0, 102, 255, 0.4);
  box-shadow: inset 0 0 15px rgba(0, 136, 255, 0.2), 0 0 25px rgba(0, 0, 50, 0.6);
  transition: all 0.3s ease;
}

/* Efecto al pasar el mouse sobre la barra completa */
#miniaturasSerie:hover {
  box-shadow: inset 0 0 25px rgba(0, 136, 255, 0.4), 0 0 35px rgba(0, 0, 80, 0.6);
  border-right: 2px solid rgba(0, 136, 255, 0.8);
}

/* === Miniaturas individuales === */
#miniaturasSerie img {
  width: 85px;
  height: 85px;
  object-fit: cover;
  border-radius: 10px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: all 0.3s ease;
  opacity: 0.85;
}

#miniaturasSerie img:hover {
  border-color: #3b82f6;
  box-shadow: 0 0 12px #3b82f6aa;
  opacity: 1;
  transform: scale(1.05);
}

#miniaturasSerie img.active {
  border-color: #3b82f6;
  box-shadow: 0 0 18px #3b82f6dd;
  opacity: 1;
}
/* === Scrollbar personalizado para miniaturas === */
#miniaturasSerie::-webkit-scrollbar {
  width: 10px;
}

#miniaturasSerie::-webkit-scrollbar-track {
  background: rgba(10, 15, 30, 0.9);
  border-radius: 10px;
  box-shadow: inset 0 0 10px rgba(0, 80, 180, 0.3);
}

#miniaturasSerie::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #0a3cff, #007bff);
  border-radius: 10px;
  box-shadow: 0 0 10px rgba(0, 140, 255, 0.7);
  transition: all 0.3s ease;
}

#miniaturasSerie::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #3399ff, #0056cc);
  box-shadow: 0 0 20px rgba(0, 170, 255, 0.9);
  transform: scale(1.05);
}
/* === Grupos === */
.tool-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

/* === Botones m√°s peque√±os === */
.tool-btn-modern {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(145deg, #0f172a, #1e293b);
  color: #60a5fa;
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(59, 130, 246, 0.4);
  box-shadow: 0 0 8px rgba(37, 99, 235, 0.3);
  transition: all 0.25s ease;
}

.tool-btn-modern:hover {
  background: linear-gradient(145deg, #1e3a8a, #2563eb);
  color: #fff;
  box-shadow: 0 0 18px rgba(59, 130, 246, 0.8);
  transform: scale(1.15);
}

/* === Etiquetas === */
.tool-label {
  font-size: 0.7rem;
  color: #60a5fa;
  opacity: 0.7;
  text-shadow: 0 0 4px rgba(59, 130, 246, 0.6);
  transition: all 0.25s ease;
}

.tool-group:hover .tool-label {
  opacity: 1;
  color: #93c5fd;
  transform: translateY(-1px);
}
@keyframes glowPulse {
  0%, 100% {
    box-shadow: 0 0 20px rgba(59,130,246,0.4), 0 0 40px rgba(59,130,246,0.2);
    border-color: rgba(59,130,246,0.6);
  }
  50% {
    box-shadow: 0 0 35px rgba(59,130,246,0.8), 0 0 60px rgba(59,130,246,0.4);
    border-color: rgba(59,130,246,1);
  }
}

.animate-glow {
  animation: glowPulse 2.5s ease-in-out infinite;
}
@keyframes visorFadeIn {
  0% {
    opacity: 0;
    transform: translateY(-20px) scale(0.95);
    filter: blur(4px);
  }
  100% {
    opacity: 1;
    transform: translateY(0) scale(1);
    filter: blur(0);
  }
}

@keyframes glowPulse {
  0%, 100% {
    box-shadow: 0 0 12px rgba(59,130,246,0.5), inset 0 0 4px rgba(59,130,246,0.3);
  }
  50% {
    box-shadow: 0 0 25px rgba(59,130,246,0.8), inset 0 0 8px rgba(59,130,246,0.6);
  }
}

#dicomViewerModal.showing #viewerControls {
  animation: visorFadeIn 1.2s ease forwards;
}

#viewerControls button {
  animation: glowPulse 3s infinite ease-in-out;
}

#dicomViewerImage {
  transition: transform 0.4s ease;
}

#orientationLabels {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none; /* para no bloquear clicks en la imagen */
}

.orientation {
  position: absolute;
  color: #3b82f6; /* azul tecnol√≥gico */
  font-weight: bold;
  font-size: 1rem;
  text-shadow: 0 0 5px rgba(0,0,0,0.8);
}

.top-center { top: 10px; left: 50%; transform: translateX(-50%); }
.left-center { top: 50%; left: 10px; transform: translateY(-50%); }
.right-center { top: 50%; right: 10px; transform: translateY(-50%); }
.bottom-center { bottom: 10px; left: 50%; transform: translateX(-50%); }

#magnifier {
  backdrop-filter: blur(3px);
  background-color: rgba(0, 20, 60, 0.25);
}

</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<!-- Toast (solo una vez en toda la app) -->
  <div id="toast" 
       class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-500">
    ‚úÖ Enlace copiado al portapapeles
  </div>
<!-- SCRIPT de cierre de login -->
<script>

<!-- LOADER -->
  <div id="loader" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 backdrop-blur-md z-50">
    <div class="loader"></div>
  </div>

function cerrarLogin() {
  const login = document.getElementById('login-screen');
  const main = document.getElementById('main-panel');

  // A√±ade la clase fade-out al login
  login.classList.add('fade-out');

  // Espera a que termine la animaci√≥n antes de ocultar y mostrar panel
  setTimeout(() => {
    login.style.display = 'none';
    main.style.display = 'block';
  }, 500); // 500ms = duraci√≥n de fade-out
}
async function recargarConAnimacion() {
  const icono = document.querySelector('.icono-recargar');
  icono.classList.add('spin');

  try {
    await cargarEstudios(); // tu funci√≥n ya existente
  } finally {
    setTimeout(() => icono.classList.remove('spin'), 1000);
  }
}
function marcarMiniaturaActiva(el) {
  document.querySelectorAll('#miniaturasSerie img').forEach(img => img.classList.remove('active'));
  el.classList.add('active');
}

function marcarImagenCentralActiva() {
  const img = document.getElementById('dicomViewerImage');
  img.classList.toggle('active');
}
document.getElementById('dicomViewerImage').addEventListener('click', marcarImagenCentralActiva);
</script>
<body>

<!-- LOGIN -->
<section id="login-screen" class="flex items-center justify-center">
  <div class="login-box">
    <div class="mb-4 flex flex-col items-center">
      <div class="brand"><span>DICOM</span>TROL</div>
    </div>

    <label class="block text-gray-700 font-medium">Usuario</label>
    <input id="username" class="w-full px-3 py-2 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="text" placeholder="admin" />

    <label class="block text-gray-700 font-medium">Contrase√±a</label>
    <input id="password" class="w-full px-3 py-2 mb-6 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="password" placeholder="clave123" />

    <button onclick="login()" class="w-full btn-red text-white py-2 rounded-lg shadow-md">Iniciar Sesi√≥n</button>
    <p id="loginError" class="text-red-600 text-center mt-4 hidden">Credenciales incorrectas</p>
  </div>
</section>

<!-- PANEL PRINCIPAL -->
<section id="main-panel">
  <div class="panel-card">
    <!-- HEADER -->
<div class="flex justify-between items-center mb-6">
  <div class="flex items-center gap-2">
    <div class="brand"><span>DICOM</span>TROL</div>
  </div>

  <div class="flex items-center gap-3">
        <!-- BOT√ìN EXPORTAR (peque√±o, igual altura que burbuja) -->
        <button id="btnExportar" class="btn-export-small flex items-center gap-2 px-3 bg-gradient-to-r from-blue-600 via-blue-500 to-blue-700 text-white font-semibold shadow-md hover:shadow-lg transition transform active:translate-y-0">
          <span style="font-size:16px">üì©‚Äã‚Äã</span>
          <span style="font-size:13px">Exportar</span>
        </button>

    <!-- BURBUJA USUARIO -->
    <div class="relative">
      <div class="flex items-center justify-center w-20 h-10 bg-blue-600 rounded-full shadow-md">
      </div>
      <span class="absolute inset-0 flex items-center justify-center text-white font-semibold text-sm">
        admin
      </span>
    </div>
  </div>
</div>

<!-- POPUP EXPORTAR -->
<div id="popupExportar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-80">
    <h2 class="text-lg font-semibold mb-4 text-gray-800">Exportar Lista de Estudios</h2>
    <p class="text-sm text-gray-600 mb-4">Selecciona el rango de tiempo que deseas exportar:</p>

    <div class="space-y-3">
      <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        onclick="exportarEstudios('hoy')">Hoy</button>
      <button class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
        onclick="exportarEstudios('semanal')">Semanal</button>
      <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
        onclick="exportarEstudios('mensual')">Mensual</button>
    </div>

    <div class="flex justify-end mt-4">
      <button onclick="cerrarPopup()" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">
        Cancelar
      </button>
    </div>
  </div>
</div>

<script>
  // Mostrar popup
  document.getElementById("btnExportar").addEventListener("click", () => {
    document.getElementById("popupExportar").classList.remove("hidden");
  });

  // Cerrar popup
  function cerrarPopup() {
    document.getElementById("popupExportar").classList.add("hidden");
  }

  // Llamada al backend
  async function exportarEstudios(rango) {
      try {
        const response = await fetch(`${API_BASE}/exportar?rango=${rango}`, {
          method: "GET"
        });

        if (!response.ok) {
          throw new Error("Error al exportar los estudios");
        }

        // Descargar el archivo Excel
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `estudios_${rango}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        cerrarPopup();
      } catch (error) {
        alert("Hubo un problema: " + error.message);
      }
    }
  </script>

<script>
// === ACTIVAR MODO PANTALLA COMPLETA AUTOM√ÅTICAMENTE ===
document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("dicomViewerModal");

  // Observa cuando el modal del visor se muestra
  const observer = new MutationObserver(() => {
    if (modal.style.display !== "none" && !document.fullscreenElement) {
      setTimeout(() => {
        if (modal.requestFullscreen) {
          modal.requestFullscreen().catch(err => console.warn("No se pudo entrar a fullscreen:", err));
        } else if (modal.webkitRequestFullscreen) {
          modal.webkitRequestFullscreen();
        }
      }, 300);
    }
  });

  observer.observe(modal, { attributes: true, attributeFilter: ["style"] });
});

// === BOT√ìN ESCAPE: SALIR DEL MODO PANTALLA COMPLETA ===
document.addEventListener("keydown", e => {
  if (e.key === "Escape" && document.fullscreenElement) {
    document.exitFullscreen();
  }
});

// === EFECTO AZUL AL CLICAR MINIATURAS ===
function marcarMiniaturaActiva(indice) {
  document.querySelectorAll("#miniaturasSerie img").forEach((thumb, i) => {
    thumb.classList.toggle("active", i === indice);
  });
}

// === EFECTO AZUL EN IMAGEN CENTRAL ===
document.addEventListener("DOMContentLoaded", () => {
  const img = document.getElementById("dicomViewerImage");
  if (img) {
    img.addEventListener("click", () => {
      img.classList.toggle("active");
    });
  }
});
</script>

 <!-- FILTROS Y BUSCADOR -->
<div class="filtros-container flex flex-col md:flex-row items-center gap-4 mb-4 w-full">
  <input id="search" 
         type="text" 
         placeholder="Buscar por nombre, ID o fecha‚Ä¶" 
         class="filtro-input flex-1 w-full md:w-auto"
         oninput="aplicarFiltros()">

  <select id="filterEstado" class="filtro-select" onchange="aplicarFiltros()">
  <option value="">Estado</option>
  <option value="En Espera">En Espera</option>
  <option value="Error">Error</option>
  <option value="Subiendo">Subiendo</option>
  <option value="Sin Informar">Sin Informar</option>
  <option value="En Proceso">En Proceso</option>
  <option value="Informado">Informado</option>
  <option value="Eliminado">Eliminado</option>
</select>

  <select id="filterMedico" class="filtro-select" onchange="aplicarFiltros()">
  <option value="">Radi√≥logos</option>
  <option value="Dra. Georgina Amalia Viyella Calzada">Dra. Georgina Amalia Viyella Calzada</option>
  <option value="Dr. Engels Liranzo">Dr. Engels Liranzo</option>
</select>

    <select id="filterModalidad" class="filtro-select" onchange="aplicarFiltros()">
         <option value="">Modalidades</option>
         <option value="MR">MR</option>
         <option value="CT">CT</option>
         <option value="DX">DX</option>
         <option value="CR">CR</option>
         <option value="PR">PR</option>
         <option value="PT">PT</option>
         <option value="US">US</option>
         <option value="MG">MG</option>
         <option value="OT">OT</option>
         <option value="SEG">SEG</option>
     </select>
<!-- Filtro Per√≠odo Compacto (solo iconos + input visible) -->
<div class="flex flex-col gap-1 w-full md:w-auto">
  <label class="text-white font-medium text-xs">Per√≠odo</label>
  <div class="flex gap-2">
    <!-- Campo Desde -->
    <div class="relative flex items-center bg-white rounded-lg px-3 py-2 border border-gray-300 shadow-sm focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/20 transition cursor-pointer group">
      <span class="text-gray-500 text-sm mr-2"> Desde: üìÖ</span>
      <input type="date" id="filterFechaDesde" class="border-none outline-none text-sm flex-1 text-transparent placeholder-transparent group-hover:text-gray-700" onchange="aplicarFiltros()" placeholder="dd/mm/yyyy">
      <button onclick="document.getElementById('filterFechaDesde').value=''; aplicarFiltros();" class="text-gray-400 hover:text-gray-600 ml-1 text-xs">√ó</button>
    </div>
    <!-- Campo Hasta -->
    <div class="relative flex items-center bg-white rounded-lg px-3 py-2 border border-gray-300 shadow-sm focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-500/20 transition cursor-pointer group">
      <span class="text-gray-500 text-sm mr-2"> Hasta: üìÖ</span>
      <input type="date" id="filterFechaHasta" class="border-none outline-none text-sm flex-1 text-transparent placeholder-transparent group-hover:text-gray-700" onchange="aplicarFiltros()" placeholder="dd/mm/yyyy">
      <button onclick="document.getElementById('filterFechaHasta').value=''; aplicarFiltros();" class="text-gray-400 hover:text-gray-600 ml-1 text-xs">√ó</button>
    </div>
  </div>
</div>
  <button id="btnRecargar" class="btn-filtro flex items-center gap-2" onclick="recargarConAnimacion()">
    <span class="icono-recargar">üîÑ</span>
    <span>Refresh</span>
  </button>
</div>

    <!-- TABLA -->
    <div class="tabla-wrapper overflow-auto flex-1">
      <table>
        <thead>
                    <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Descripci√≥n</th>
                    <th>ID Paciente</th>
                    <th>Modalidad</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                    </tr>
                    </thead>
        <tbody id="tablaEstudios"></tbody>
      </table>
<!-- Controles de paginaci√≥n -->
<div class="flex justify-center mt-4 gap-2">
  <button id="btnPrev" onclick="prevPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">
    ‚¨Ö Anterior
  </button>
  <button id="btnNext" onclick="nextPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">
    Siguiente ‚û°
  </button>
</div>
    </div>
  </div>
</section>

<!-- MODAL SERIES -->
<div id="modalSeries" class="hidden fixed inset-0 z-40 flex items-start justify-center modal-bg pt-20">
<div class="modal-card relative max-w-6xl w-full">
<div class="absolute top-2 right-2 flex gap-2">
<button onclick="cerrarModalSeries()" class="px-3 py-1 rounded bg-gray-700 text-white">Cerrar</button>
</div>
<h2 class="text-xl font-bold text-white mb-4">Series del Estudio</h2>
<div id="seriesContainer" class="space-y-4"></div>
</div>
</div>


<div id="visorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-6">
<div class="modal-card relative max-w-7xl w-full">
<button onclick="cerrarVisor()" class="absolute top-3 right-3 px-3 py-1 rounded bg-gray-700 text-white">Cerrar</button>
<div class="card p-4 flex flex-col md:flex-row gap-4">
<div id="visorImageContainer" class="flex-1 flex items-center justify-center"><img id="visorImage" src="" alt="Imagen grande"/></div>
<div id="visorMeta" class="p-4 border-l"><h3 id="metaNombre" class="font-bold text-lg text-white mb-2"></h3><div id="metaBody"></div></div>
</div>
</div>
</div>

<!-- VISOR DICOM EVO STYLE -->
<div id="modalSeries" class="hidden fixed inset-0 z-40 flex items-start justify-center modal-bg pt-20">
<div class="modal-card relative max-w-6xl w-full">
<div class="absolute top-2 right-2 flex gap-2">
<button onclick="cerrarModalSeries()" class="px-3 py-1 rounded bg-gray-700 text-white">Cerrar</button>
</div>
<h2 class="text-xl font-bold text-white mb-4">Series del Estudio</h2>
<div id="seriesContainer" class="space-y-4"></div>
</div>
</div>


<div id="visorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-6">
<div class="modal-card relative max-w-7xl w-full">
<button onclick="cerrarVisor()" class="absolute top-3 right-3 px-3 py-1 rounded bg-gray-700 text-white">Cerrar</button>
<div class="card p-4 flex flex-col md:flex-row gap-4">
<div id="visorImageContainer" class="flex-1 flex items-center justify-center"><img id="visorImage" src="" alt="Imagen grande"/></div>
<div id="visorMeta" class="p-4 border-l"><h3 id="metaNombre" class="font-bold text-lg text-white mb-2"></h3><div id="metaBody"></div></div>
</div>
</div>
</div>


<!-- VISOR DICOM EVO STYLE -->
<!-- VISOR DICOM AZUL/NEGRO A PANTALLA COMPLETA -->
<!-- VISOR DICOM AZUL/NEGRO A PANTALLA COMPLETA -->
<div id="dicomViewerModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black">
  <div id="dicomViewerCard" class="relative w-screen h-screen bg-black">

 <!-- Botones cerrar / expandir -->
<div class="absolute top-4 right-4 flex gap-3 z-50">
  <!-- Expandir / Restaurar -->
  <button id="expandBtn"
    onclick="toggleExpandViewer()"
    title="Expandir/Restaurar"
    class="w-11 h-11 rounded-full bg-gradient-to-br from-blue-700/40 to-blue-500/20 
           border border-blue-400/40 text-blue-200 flex items-center justify-center 
           backdrop-blur-md shadow-[0_0_12px_rgba(59,130,246,0.4)]
           hover:scale-110 hover:shadow-[0_0_25px_rgba(59,130,246,0.7)]
           hover:border-blue-400 transition-all duration-300 ease-out">
    ‚§¢
  </button>

  <!-- Cerrar -->
  <button onclick="cerrarModalViewer()"
    title="Cerrar"
    class="w-11 h-11 rounded-full bg-gradient-to-br from-red-600/40 to-red-400/20 
           border border-red-400/50 text-red-200 flex items-center justify-center 
           backdrop-blur-md shadow-[0_0_12px_rgba(239,68,68,0.4)]
           hover:scale-110 hover:shadow-[0_0_25px_rgba(239,68,68,0.7)]
           hover:border-red-400 transition-all duration-300 ease-out">
    ‚úñ
  </button>
</div>

    <!-- Barra superior de herramientas -->
    <div id="toolbar"
  class="absolute top-4 left-24 z-40 bg-gradient-to-r from-[#0a0f1a]/90 to-[#0f172a]/90
         backdrop-blur-xl border border-blue-500/40
         shadow-[0_0_15px_rgba(59,130,246,0.25)]
         rounded-full px-5 py-2 flex gap-4
         transition-all duration-700 ease-out
         opacity-0 -translate-y-5 scale-95 hover:shadow-[0_0_25px_rgba(59,130,246,0.6)]">
  
  <div class="tool-group">
    <button class="tool-btn-modern" onclick="activateTool('Zoom')" title="Zoom">üîçÔ∏é</button>
    <span class="tool-label">Zoom</span>
  </div>

  <div class="tool-group">
    <button class="tool-btn-modern" onclick="activateTool('Pan')" title="Pan">„Äå„Äç</button>
    <span class="tool-label">Pan</span>
  </div>

  <div class="tool-group">
    <button class="tool-btn-modern" onclick="activateTool('Wwwc')" title="Brillo/Contraste">‚òæ‚òº</button>
    <span class="tool-label">Brillo</span>
  </div>

<!-- Bot√≥n Girar -->
<div class="tool-group">
  <button class="tool-btn-modern" onclick="rotateImage()" title="Girar">‚ü≥</button>
  <span class="tool-label">Girar</span>
</div>

  <!-- Bot√≥n Medir con subopciones -->
<div class="tool-group relative flex flex-col items-center">
  <!-- Bot√≥n principal -->
  <div class="flex items-center gap-1">
    <button class="tool-btn-modern" id="measureBtn" title="Medir">‚úé·ù∞</button>
    <button id="measureDropdownBtn" class="text-xs px-1">‚ñº</button>
  </div>

  <!-- Etiqueta visible siempre -->
  <span class="tool-label">Medir</span>

  <!-- Subopciones desplegables -->
  <div id="measureOptions" class="absolute hidden top-12 left-0 bg-gray-800 text-white rounded-md shadow-lg py-1 z-50 flex flex-col">
    <button onclick="activateTool('Length')">Distancia</button>
    <button onclick="activateTool('Area')">√Årea</button>
    <button onclick="activateTool('Angle')">√Ångulo</button>
    <button onclick="activateTool('Text')">Texto</button>
    <button onclick="copyMeasurement()">Copiar</button>
  </div>
</div>

<div class="tool-group">
  <button class="tool-btn-modern" onclick="toggleMagnifier()" title="Lupa">üîç</button>
  <span class="tool-label">Lupa</span>
</div>

  <div class="tool-group">
    <button class="tool-btn-modern" onclick="resetView()" title="Reset">‚Ü∫</button>
    <span class="tool-label">Reset</span>
  </div>

<div class="tool-group">
  <button class="tool-btn-modern" onclick="exportImage()" title="Exportar">‚Üì</button>
  <span class="tool-label">Exportar</span>
</div>

  <div class="tool-group relative flex flex-col items-center">
  <!-- Bot√≥n principal -->
  <button class="tool-btn-modern" id="cineBtn" title="Cine">[‚ñ∏]</button>

  <!-- Etiqueta visible siempre -->
  <span class="tool-label">Cine</span>

  <!-- Subopciones desplegables -->
  <div id="cineOptions" class="absolute hidden top-12 left-0 bg-gray-800 text-white rounded-md shadow-lg py-1 z-50 px-2 flex flex-col gap-1">
    <button onclick="playCine()">‚ñ∂ Play</button>
    <button onclick="pauseCine()">‚ùö‚ùö Pause</button>
    <div class="flex justify-between items-center">
      <button onclick="decreaseFPS()">- FPS</button>
      <span id="currentFPS">30 FPS</span>
      <button onclick="increaseFPS()">+ FPS</button>
    </div>
  </div>
</div>

</div>

<!-- √Årea principal -->
    <div class="flex w-full h-full items-center justify-center">
      
      <!-- Miniaturas -->
      <div id="miniaturasSerie" class="flex flex-col gap-3 overflow-y-auto p-4 rounded-r-2xl shadow-inner backdrop-blur-md">
  <!-- Miniaturas cargadas din√°micamente -->
</div>

      <!-- Imagen central -->
      <div id="dicomCanvas" class="flex-1 flex items-center justify-center bg-black relative">
        <div id="dicomImageWrapper" class="relative">

          <!-- Imagen del estudio -->
          <img id="dicomViewerImage" 
               src="https://via.placeholder.com/1200x900?text=DICOM" 
               alt="DICOM" 
               draggable="false" 
               class="rounded-lg cursor-pointer shadow-2xl transition-all duration-300"/>

          <!-- SVG overlay (mediciones, etc.) -->
          <svg id="overlaySvg" xmlns="http://www.w3.org/2000/svg"></svg>
<!-- Letras tipo br√∫jula -->
    <div id="orientationLabels">
      <div class="orientation top-center">A</div>
      <div class="orientation left-center">R</div>
      <div class="orientation right-center">L</div>
      <div class="orientation bottom-center">P</div>
    </div>

  </div>
</div>

<script>
const API_BASE = "https://visor-dicom-backend.onrender.com";

/* ========== GLOBALS ========== */
let imagenesSerieActual = [];
let indiceImagenActual = 0;
let estudios = [];
let estudiosFiltrados = [];

/* Transform/visual state */
const wrapper = () => document.getElementById('dicomImageWrapper');
const imgEl = () => document.getElementById('dicomViewerImage');
const overlay = () => document.getElementById('overlaySvg');

let state = {
  scale: 1,
  translateX: 0,
  translateY: 0,
  brightness: 1,
  contrast: 1,
  tool: null,
  dragging: false,
  dragStart: {x:0,y:0},
  panStart: {x:0,y:0},
  measurePts: [], // for length/area
  currentShape: null
};

/* ========== UTILS ========== */
function applyTransform() {
  const w = wrapper();
  w.style.transform = `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
  const img = imgEl();
  img.style.filter = `brightness(${state.brightness}) contrast(${state.contrast})`;
}

/* Reset view */
function resetView() {
  state.scale = 1;
  state.translateX = 0;
  state.translateY = 0;
  state.brightness = 1;
  state.contrast = 1;
  clearOverlays();
  applyTransform();
}

/* Toggle expand */
function toggleExpandViewer() {
  const card = document.getElementById('dicomViewerCard');
  card.classList.toggle('expanded');
  // forzar imagen a ocupar todo el espacio disponible
  imgEl().style.width = "100%";
  imgEl().style.height = "100%";
  imgEl().style.objectFit = "contain"; // mantiene proporci√≥n
}

/* ========== OPEN/CLOSE VISOR ========== */
function cerrarModalViewer() {
  const modal = document.getElementById("dicomViewerModal");
  modal.classList.add("hidden");
  imgEl().src = "";
  // NO tocar dicomInfo aqu√≠
  resetView();
}

/* ========== TOOL ACTIVATION ========== */
function activateTool(toolName) {
  // clear measurement state on tool change
  state.tool = toolName;
  state.measurePts = [];
  removeCurrentSVGShape();
  // show tool in console for debugging
  console.log('Herramienta activa:', toolName);
}

/* ========== WHEEL (zoom / wwwc) ========== */
document.getElementById('dicomImageWrapper').addEventListener('wheel', function(e){
  // get mounted tool
  if(!state.tool) return;
  if(state.tool === 'Zoom') {
    e.preventDefault();
    const delta = (e.deltaY < 0) ? 1.08 : 0.925;
    // zoom toward cursor: adjust translate so it zooms to pointer
    const rect = wrapper().getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    // compute offset before scale
    const prevScale = state.scale;
    state.scale = Math.max(0.2, Math.min(8, state.scale * delta));
    // adjust translate to keep point under cursor stable
    state.translateX = (state.translateX - cx) * (state.scale / prevScale) + cx;
    state.translateY = (state.translateY - cy) * (state.scale / prevScale) + cy;
    applyTransform();
  } else if (state.tool === 'Wwwc') {
    e.preventDefault();
    // adjust brightness with wheel
    const change = -e.deltaY * 0.0015;
    state.brightness = Math.max(0.2, Math.min(3, state.brightness + change));
    // optionally change contrast a bit too:
    state.contrast = Math.max(0.2, Math.min(3, state.contrast + change*0.6));
    applyTransform();
  }
}, { passive: false });

/* ========== PAN (drag) ========== */
document.getElementById('dicomImageWrapper').addEventListener('pointerdown', function(e){
  if (state.tool === 'Pan') {
    state.dragging = true;
    state.dragStart = { x: e.clientX, y: e.clientY };
    state.panStart = { x: state.translateX, y: state.translateY };
    document.body.style.cursor = 'grabbing';
    e.preventDefault();
  }
});
window.addEventListener('pointermove', function(e){
  if (state.dragging && state.tool === 'Pan') {
    const dx = e.clientX - state.dragStart.x;
    const dy = e.clientY - state.dragStart.y;
    state.translateX = state.panStart.x + dx;
    state.translateY = state.panStart.y + dy;
    applyTransform();
  }
});
window.addEventListener('pointerup', function(){
  if(state.dragging) {
    state.dragging = false;
    document.body.style.cursor = 'default';
  }
});

/* ========== MEASUREMENT (Length & Area) ========== */
function clearOverlays() {
  const sv = overlay();
  while (sv.firstChild) sv.removeChild(sv.firstChild);
  state.measurePts = [];
  state.currentShape = null;
}
function removeCurrentSVGShape(){
  if(state.currentShape && state.currentShape.parentNode) {
    state.currentShape.parentNode.removeChild(state.currentShape);
    state.currentShape = null;
  }
}

let rotationAngle = 0;

function rotateImage() {
  const img = document.getElementById('dicomViewerImage');
  rotationAngle = (rotationAngle + 90) % 360;
  img.style.transform = `rotate(${rotationAngle}deg)`;
}

/* helper: create SVG elements */
function svgLine(x1,y1,x2,y2, cls='measure-line') {
  const ns = 'http://www.w3.org/2000/svg';
  const line = document.createElementNS(ns, 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('class', cls);
  return line;
}
function svgCircle(cx,cy,r=4, cls='measure-dot') {
  const ns = 'http://www.w3.org/2000/svg';
  const c = document.createElementNS(ns, 'circle');
  c.setAttribute('cx', cx);
  c.setAttribute('cy', cy);
  c.setAttribute('r', r);
  c.setAttribute('class', cls);
  return c;
}
function svgText(x,y,text, cls='measure-text') {
  const ns = 'http://www.w3.org/2000/svg';
  const t = document.createElementNS(ns, 'text');
  t.setAttribute('x', x);
  t.setAttribute('y', y);
  t.setAttribute('class', cls);
  t.textContent = text;
  return t;
}
function svgPolygon(pointsStr, cls='measure-line') {
  const ns = 'http://www.w3.org/2000/svg';
  const p = document.createElementNS(ns, 'polygon');
  p.setAttribute('points', pointsStr);
  p.setAttribute('fill', 'rgba(0,255,200,0.08)');
  p.setAttribute('stroke', '#00ffd1');
  p.setAttribute('stroke-width','2');
  return p;
}

/* distance between two points */
function dist(p1,p2) {
  const dx = p1.x - p2.x;
  const dy = p1.y - p2.y;
  return Math.sqrt(dx*dx + dy*dy);
}

/* compute polygon area (signed) */
function polygonArea(points) {
  let area = 0;
  for (let i=0;i<points.length;i++){
    const j = (i+1)%points.length;
    area += points[i].x * points[j].y - points[j].x * points[i].y;
  }
  return Math.abs(area / 2);
}

/* click handling for measurements */
document.getElementById('dicomImageWrapper').addEventListener('click', function(e){
  const tool = state.tool;
  if(!tool) return;
  // get click coords relative to wrapper
  const rect = wrapper().getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if(tool === 'Length') {
    // push point
    state.measurePts.push({x,y});
    redrawMeasures();
    if(state.measurePts.length === 2) {
      // finalize: compute distance and show text
      const a = state.measurePts[0], b = state.measurePts[1];
      const d = dist(a,b).toFixed(1); // pixels
      const mid = { x: (a.x+b.x)/2, y: (a.y+b.y)/2 };
      overlay().appendChild(svgText(mid.x+6, mid.y-6, `${d}px`));
      // keep points on screen until tool reset or next action
      state.measurePts = []; // reset for new measure
    }
  } else if(tool === 'Area') {
    // accumulate points until double click to close (double click event handled below)
    state.measurePts.push({x,y});
    redrawMeasures();
  } else {
    // other tools ignored for clicks
  }
});

/* double click => finish polygon */
document.getElementById('dicomImageWrapper').addEventListener('dblclick', function(e){
  if(state.tool !== 'Area') return;
  if(state.measurePts.length < 3) {
    // not enough points
    return;
  }
  // compute area
  const areaPx = polygonArea(state.measurePts).toFixed(1);
  // draw final polygon and label
  const pointsStr = state.measurePts.map(p => `${p.x},${p.y}`).join(' ');
  overlay().appendChild(svgPolygon(pointsStr));
  // label near centroid
  const cx = state.measurePts.reduce((s,p)=>s+p.x,0)/state.measurePts.length;
  const cy = state.measurePts.reduce((s,p)=>s+p.y,0)/state.measurePts.length;
  overlay().appendChild(svgText(cx+6, cy-6, `${areaPx} px¬≤`));
  // clear accumulation
  state.measurePts = [];
});

/* redraw measure preview (live) */
function redrawMeasures() {
  const sv = overlay();
  // clear only shapes created for preview (we'll wipe all and re-add persistent ones)
  while (sv.firstChild) sv.removeChild(sv.firstChild);
  // draw points
  for(let i=0;i<state.measurePts.length;i++){
    const p = state.measurePts[i];
    sv.appendChild(svgCircle(p.x,p.y,3));
    if(i>0){
      const prev = state.measurePts[i-1];
      sv.appendChild(svgLine(prev.x,prev.y,p.x,p.y));
    }
  }
}

/* ========== IMAGE LOADING & METADATA ========== */
async function abrirDicomViewerConSerie(serieId){
  try{
    document.getElementById("modalSeries").classList.add("hidden");
    document.getElementById("dicomViewerModal").classList.remove("hidden");

    // Cargar im√°genes de la serie
    const res = await fetch(`${API_BASE}/series/${serieId}/imagenes`);
    if(!res.ok) throw new Error("No se pudieron cargar las im√°genes de la serie");
    const imagenes = await res.json();
    if(imagenes.length === 0) throw new Error("Serie sin im√°genes");

    // ‚úÖ Asignar imagenes y mostrar primera imagen
    imagenesSerieActual = imagenes;
    indiceImagenActual = 0;
    mostrarImagenSerie(indiceImagenActual);

    // ‚úÖ Cargar miniaturas en la columna lateral
    cargarMiniaturasEVO(imagenes);

    // ‚úÖ Resetear vista
    resetView();
  }catch(err){
    alert("No se pudo abrir el visor DICOM: " + err.message);
    console.error(err);
  }
}
/* mostrar imagen y metadata */
async function mostrarImagenSerie(indice) {
  if (indice < 0 || indice >= imagenesSerieActual.length) return;

  indiceImagenActual = indice;
  const imgObj = imagenesSerieActual[indice];

  // Marcar miniatura activa
  document.querySelectorAll("#miniaturasSerie img").forEach((thumb, i) => {
    thumb.style.border = i === indice ? "3px solid blue" : "1px solid #ccc";
  });

  // Mostrar imagen grande
  const dicomImg = document.getElementById("dicomViewerImage");
  dicomImg.src = imgObj.preview_base64
    ? `data:image/png;base64,${imgObj.preview_base64}`
    : `${API_BASE}/imagen/${imgObj.id}?frame=0`;

  // --- Obtener estudio completo ---
  let estudio = {};
  try {
    const resEst = await fetch(`${API_BASE}/estudios/${imgObj.estudio_id}`);
    if (resEst.ok) estudio = await resEst.json();
  } catch (err) {
    console.error("Error cargando estudio:", err);
  }

  // --- Obtener serie completa ---
  let serie = {};
  try {
    const resSer = await fetch(`${API_BASE}/series/${imgObj.serie_id}`);
    if (resSer.ok) serie = await resSer.json();
  } catch (err) {
    console.error("Error cargando serie:", err);
  }

  // --- Actualizar panel lateral ---
  document.getElementById("dicomInfo").innerHTML = `
    <p><b>Paciente:</b> ${estudio?.nombre || imgObj.paciente || imgObj.paciente_nombre || "--"}</p>
    <p><b>ID:</b> ${estudio?.paciente_id || imgObj.paciente_id || imgObj.patient_id || "--"}</p>
    <p><b>Fecha Nac.:</b> ${formatNacimiento(estudio?.nacimiento) || "--"}</p>
    <p><b>Fecha Estudio:</b> ${formatFecha(estudio?.fecha) || imgObj.fecha || imgObj.study_date || "--"}</p>
    <p><b>Fecha Llegada:</b> ${formatFecha(estudio?.created_at) || "--"}</p>
    <p><b>Instituci√≥n:</b> ${estudio?.institucion || "--"}</p>
    <hr/>
    <p><b>Serie:</b> ${serie?.series_description || imgObj.serie_descripcion || imgObj.series_description || "--"}</p>
    <p><b>Parte cuerpo:</b> ${serie?.body_part || "--"}</p>
    <p><b>M√©dico remitente:</b> ${serie?.medico_remitente || imgObj.medico || imgObj.medico_remitente || "--"}</p>
  `;

  clearOverlays();
}

/* ========== NAVIGATION ========== */
function cambiarImagen(direccion){
  indiceImagenActual += direccion;
  if(indiceImagenActual < 0) indiceImagenActual = 0;
  if(indiceImagenActual >= imagenesSerieActual.length) indiceImagenActual = imagenesSerieActual.length - 1;
  mostrarImagenSerie(indiceImagenActual);
}

/* ========== VISOR MINIATURAS (series) ========== */
async function cargarImagenesSerie(serieId, estudioId, serieObj){
  const cont=document.getElementById(`imagenes_${serieId}`);
  cont.innerHTML="Cargando im√°genes...";
  try{
    const res=await fetch(`${API_BASE}/series/${serieId}/imagenes`);
    if(!res.ok) throw new Error("no imagenes");
    const imagenes = await res.json();
    cont.innerHTML="";
    for(const img of imagenes){
      const imgElem=document.createElement("div");
      imgElem.className="series-item";
      const src = img.preview_base64 ? `data:image/png;base64,${img.preview_base64}` : `${API_BASE}/imagen/${img.id}?frame=0`;
      imgElem.innerHTML=`<img id="img_${img.id}" src="${src}" onclick="abrirVisor(${img.id}, ${estudioId}, ${serieId})" alt="miniatura" style="max-width:100%; max-height:100%; object-fit:cover;"/>`;
      cont.appendChild(imgElem);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las im√°genes";
    console.error(err);
  }
}

/* abrir visor simple (visorModal) para miniatura grande */
async function abrirVisor(imagenId, estudioId, serieId) {
  try {
    const visorImg = document.getElementById("dicomViewerImage");
    visorImg.src = `${API_BASE}/imagen/${imagenId}`;

    // Llamar a mostrarImagenSerie para actualizar metadata lateral autom√°ticamente
    const indice = imagenesSerieActual.findIndex(i => i.id === imagenId);
    if (indice >= 0) await mostrarImagenSerie(indice);

    document.getElementById("dicomViewerModal").classList.remove("hidden");
  } catch (err) {
    alert("No se pudo abrir visor");
    console.error(err);
  }
}

/* ========== CERRAR VISOR ========== */
function cerrarModalViewer() {
  const modal = document.getElementById("dicomViewerModal");
  modal.classList.add("hidden");
  document.getElementById("dicomViewerImage").src = "";
  document.getElementById("dicomInfo").innerHTML = `
    <p><b>Paciente:</b> --</p>
    <p><b>ID:</b> --</p>
    <p><b>Fecha Nac.:</b> --</p>
    <p><b>Fecha Estudio:</b> --</p>
    <p><b>Fecha Llegada:</b> --</p>
    <p><b>Instituci√≥n:</b> --</p>
    <p><b>Serie:</b> --</p>
    <p><b>Parte cuerpo:</b> --</p>
    <p><b>M√©dico remitente:</b> --</p>`;
  resetView();
}

function cerrarVisor(){
  document.getElementById("visorModal").classList.add("hidden");
  document.getElementById("visorImage").src = "";
}

/* ========== OTRAS FUNCIONES (login, cargarEstudios, filtros...) ========== */
// Copi√© y mantuve el resto de tu l√≥gica para login, carga de estudios y filtros exactamente igual
// (para ahorro de espacio no repito funciones largas que ya exist√≠an arriba en tu c√≥digo;
// en caso de que quieras que reinsert√© TODO exactamente l√≠nea por l√≠nea, lo hago tambi√©n).

async function login() {
  const usuario = document.getElementById("username").value;
  const clave = document.getElementById("password").value;
  const loginScreen = document.getElementById("login-screen");
  const mainPanel = document.getElementById("main-panel");

  if (usuario === "admin" && clave === "clave123") {
    // Fade-out login
    loginScreen.classList.add("fade-out");

    setTimeout(() => {
      loginScreen.style.display = "none";

      // Mostrar panel principal y hacer fade-in
      mainPanel.style.display = "flex";
      mainPanel.classList.add("visible");

      // Llamar a la funci√≥n async que carga estudios
      cargarEstudios(); 

    }, 500); // duraci√≥n de fade-out
  } else {
    document.getElementById("loginError").classList.remove("hidden");
  }
}

// Formato dd-mm-yyyy
function formatFechaCorta(fechaStr) {
  if (!fechaStr) return "";
  const d = new Date(fechaStr);
  if (isNaN(d.getTime())) return "";
  const dia = String(d.getDate()).padStart(2, '0');
  const mes = String(d.getMonth() + 1).padStart(2, '0');
  const anio = d.getFullYear();
  return `${dia}-${mes}-${anio}`;
}

// Hora en formato 12h: 03:34:45 PM
function formatHora12(fechaStr) {
  if (!fechaStr) return "";
  const d = new Date(fechaStr);
  if (isNaN(d.getTime())) return "";
  let h = d.getHours();
  const m = String(d.getMinutes()).padStart(2, '0');
  const s = String(d.getSeconds()).padStart(2, '0');
  const ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12;
  h = h ? h : 12;
  h = String(h).padStart(2, '0');
  return `${h}:${m}:${s} ${ampm}`;
}

// Tiempo transcurrido: "hace 2 horas", "hace 45 mins", etc.
function tiempoTranscurrido(fechaStr) {
  if (!fechaStr) return "";
  const ahora = new Date();
  const entonces = new Date(fechaStr);
  if (isNaN(entonces.getTime())) return "";

  const diffMs = ahora - entonces;
  const diffSeg = Math.floor(diffMs / 1000);
  const diffMin = Math.floor(diffSeg / 60);
  const diffHoras = Math.floor(diffMin / 60);
  const diffDias = Math.floor(diffHoras / 24);

  if (diffDias > 0) {
    return `hace ${diffDias} d√≠a${diffDias > 1 ? 's' : ''}`;
  } else if (diffHoras > 0) {
    return `hace ${diffHoras} hora${diffHoras > 1 ? 's' : ''}`;
  } else if (diffMin > 0) {
    return `hace ${diffMin} min`;
  } else {
    return `hace unos segundos`;
  }
}

// Renderizado de filas con expansi√≥n
function renderEstudioConExpansion(estudio) {
  const tbody = document.getElementById("tablaEstudios");

  const tr = document.createElement("tr");
  tr.classList.add("fila-estudio");
  // Valor de modalidad: usa estudio.modalidad o "MR" por defecto
const modalidad = estudio.modalidad || "MR";

tr.innerHTML = `
<td>${estudio.nombre || "--"}</td>
<td>
<div class="text-sm font-medium">${formatFechaCorta(estudio.created_at) || "--"}</div>
<div class="text-xs text-gray-600 mt-1">Hora de registro: ${formatHora12(estudio.created_at) || "--"}</div>
<div class="text-[10px] text-gray-500 mt-1">${tiempoTranscurrido(estudio.created_at)}</div>
</td>
<td>${estudio.descripcion || "--"}</td>
<td>${estudio.paciente_id || "--"}</td>
<td class="text-center font-medium">${modalidad}</td>
<td class="estado-col">
  <span class="badge-estado estado-${(estudio.estado || "Pendiente").replace(/\s+/g, '-').toLowerCase()}">
    ${estudio.estado || "Pendiente"}
  </span>
</td>
<td class="acciones-col" style="display: flex; gap: 8px; justify-content: center; align-items: center;">
  <!-- Bot√≥n Ver -->
  <button 
    class="btn-accion btn-ver"
    onclick="abrirVisorDesdeTabla(${estudio.id})"
    title="Ver estudio"
  >
    <img src="assets/icon-ver.png" alt="Ver">
  </button>

  <!-- Bot√≥n Reportes -->
  <button 
    class="btn-accion btn-reportes"
    onclick="abrirReportes(${estudio.id})"
    title="Reportes"
  >
    <img src="assets/icon-reportes.png" alt="Reportes">
  </button>

  <!-- Bot√≥n Audios -->
  <button 
    class="btn-accion btn-audios"
    onclick="abrirAudios(${estudio.id})"
    title="Audios"
  >
    <img src="assets/icon-audios.png" alt="Audios">
  </button>
</td>
`;

  const panel = document.createElement("tr");
  panel.classList.add("fila-expandida");
  panel.style.display = "none";
  panel.innerHTML = `
  <td colspan="9">
    <div class="panel-opciones">
      <div>
        <span>Estado de Estudio:</span>
        <span class="icono-ojo" data-estado="pendiente">üëÅÔ∏è</span>
      </div>
      <div>
        <span>üìë Cantidad de Series:</span> ${estudio.num_series || 0}
      </div>
      <div>
        <button class="btn-icon btn-exportar" data-id="${estudio.id}">‚¨á Exportar</button>
        <button class="btn-icon" onclick="abrirVisorDesdeTabla(${estudio.id})">‚úè Observar</button>
      </div>
      <div>
        <label>üë®‚Äç‚öï M√©dico Remitente:</label>
        <input type="text" value="${estudio.medico || ""}" class="input-medico"/>
      </div>
      <div>
        <button class="btn-icon btn-importar" data-id="${estudio.id}">üìÑ Importar Informe</button>
        <input type="file" class="file-informe hidden" accept=".pdf,.txt,.docx"/>
      </div>
    </div>

    <!-- Aqu√≠ mostramos el QR -->
<div class="mt-3 p-3 bg-white border rounded shadow flex flex-col items-start">
  <p class="font-semibold mb-2">üîó Acceso r√°pido</p>
  <div id="qrcode-${estudio.id}" class="mb-2"></div>
  <button onclick="copiarLink('${estudio.id}')"
    class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
    Copiar enlace
  </button>
</div>

<!-- Aqu√≠ mostramos los informes -->
<div id="informes-${estudio.id}" class="informes-panel mt-3"></div>
`;

  // Expansi√≥n al hacer click
  tr.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-ver")) return;
    panel.style.display = panel.style.display === "none" ? "table-row" : "none";
  });

  // Cambiar estado con el üëÅÔ∏è
  panel.querySelector(".icono-ojo").addEventListener("click", (e) => {
    const ojo = e.target;
    const estadoCol = tr.querySelector(".estado-col");
    if (ojo.dataset.estado === "pendiente") {
      ojo.dataset.estado = "visto";
      estadoCol.textContent = "Visto ‚úÖ";
    } else {
      ojo.dataset.estado = "pendiente";
      estadoCol.textContent = "Pendiente";
    }
  });

  // === BOT√ìN EXPORTAR ===
  panel.querySelector(".btn-exportar").addEventListener("click", async () => {
    const id = estudio.id;
    try {
      const res = await fetch(`${API_BASE}/exportar/${id}`);
      if (!res.ok) throw new Error("Error exportando estudio");
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `estudio_${id}.zip`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      alert("No se pudo exportar el estudio");
      console.error(err);
    }
  });

  // === BOT√ìN IMPORTAR INFORME ===
  const fileInput = panel.querySelector(".file-informe");
panel.querySelector(".btn-importar").addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append("informe", file);

  try {
    const res = await fetch(`${API_BASE}/importar_informe/${estudio.id}`, {
      method: "POST",
      body: formData
    });
    if (!res.ok) throw new Error("Error subiendo informe");
    const result = await res.json();

    // üìå Ahora insertamos el informe en el panel justo debajo del QR
    const informesPanel = document.getElementById(`informes-${estudio.id}`);
    const wrapper = document.createElement("div");
    wrapper.classList.add("informe-item");

    if (file.type === "application/pdf") {
      wrapper.innerHTML = `
        <p class="font-bold">üìÑ ${file.name}</p>
        <iframe src="${API_BASE}/informes/${result.filename}" 
                class="w-full h-64 border rounded"></iframe>
      `;
    } else {
      wrapper.innerHTML = `
        <p class="font-bold">üìÑ ${file.name}</p>
        <pre class="bg-gray-100 p-2 rounded">${await file.text()}</pre>
      `;
    }

    informesPanel.appendChild(wrapper);
  } catch (err) {
    alert("No se pudo importar el informe");
    console.error(err);
  }
});

  tbody.appendChild(tr);
  tbody.appendChild(panel);
// === GENERAR QR ===
const qrContainer = document.getElementById(`qrcode-${estudio.id}`);
if (qrContainer) {
  new QRCode(qrContainer, {
    text: `${window.location.origin}/estudio/${estudio.id}`, // URL √∫nica
    width: 100,
    height: 100,
  });
}
}
async function cargarEstudios() {
  try {
    const res = await fetch(`${API_BASE}/estudios`);
    if (!res.ok) throw new Error("Error al obtener estudios");
    const data = await res.json();

    // Limpiar y guardar en el array global
    estudios.length = 0;
    estudios.push(...data);

    // Renderizar en tabla
    const tbody = document.getElementById("tablaEstudios");
    tbody.innerHTML = "";
    estudios.forEach(e => renderEstudioConExpansion(e));

  } catch (err) {
    console.error(err);
    alert("No se pudo cargar los estudios");
  }
}
function abrirVisorDesdeTabla(estudioId) {
  // buscar el estudio en el array global
  const est = estudios.find(e => e.id === estudioId);
  if (!est) {
    alert("Estudio no encontrado");
    return;
  }

  // abrir directamente el modal de series de ese estudio
  abrirModalSeries(est.id);
}

function aplicarFiltros(){
  const q = (document.getElementById("search").value || "").toLowerCase();
  const estado = document.getElementById("filterEstado").value;
  const medico = document.getElementById("filterMedico").value;
  const modalidad = document.getElementById("filterModalidad")?.value || "";
  const desde = document.getElementById("filterFechaDesde").value;
  const hasta = document.getElementById("filterFechaHasta").value;

  estudiosFiltrados = estudios.filter(e => {
    let match = true;

    // B√∫squeda general
    if (q && !(
      (e.nombre || "").toLowerCase().includes(q) ||
      (e.paciente_id || "").toLowerCase().includes(q) ||
      (e.fecha || "").toLowerCase().includes(q)
    )) match = false;

    // Filtros
    if (estado && e.estado !== estado) match = false;
    if (medico && e.medico_remitente !== medico) match = false;
    const modalidadEstudio = e.modalidad || "MR";
    if (modalidad && modalidadEstudio !== modalidad) match = false;

    // Rango de fechas (usa created_at)
    if (desde || hasta) {
      const fechaEstudio = new Date(e.created_at).getTime();
      if (desde && fechaEstudio < new Date(desde).getTime()) match = false;
      if (hasta && fechaEstudio > new Date(hasta).getTime() + 86399999) match = false; // incluir todo el d√≠a
    }

    return match;
  });

  // ‚úÖ Renderizar con expansi√≥n (QR, botones, etc.)
  const tbody = document.getElementById("tablaEstudios");
  tbody.innerHTML = "";
  estudiosFiltrados.forEach(e => renderEstudioConExpansion(e));
}

function renderTabla(){
  const tbody=document.getElementById("tablaEstudios");
  tbody.innerHTML="";
  estudiosFiltrados.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.nombre||""}</td>
      <td>
                    <div class="text-sm font-medium">${formatFechaCorta(estudio.created_at) || "--"}</div>
                    <div class="text-xs text-gray-600 mt-1">Hora de registro: ${formatHora12(estudio.created_at) || "--"}</div>
                    <div class="text-[10px] text-gray-500 mt-1">${tiempoTranscurrido(estudio.created_at)}</div>
               </td>
      <td>${formatNacimiento(e.nacimiento)}</td>
      <td>${e.descripcion||""}</td>
      <td>${e.paciente_id||""}</td>
      <td>${e.institucion||""}</td>
      <td>${e.num_imagenes||0}</td>
      <td>${e.estado||""}</td>
      <td><button onclick="abrirModalSeries(${e.id})" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Ver</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// abrir modal series
async function abrirModalSeries(estudioId){
  const modal=document.getElementById("modalSeries");
  const cont=document.getElementById("seriesContainer");
  cont.innerHTML="Cargando series...";
  modal.classList.remove("hidden");

  try{
    const res=await fetch(`${API_BASE}/estudios/${estudioId}/series`);
    if(!res.ok) throw new Error("no series");
    const series = await res.json();
    cont.innerHTML="";
    for(const s of series){
     const div=document.createElement("div");
div.className="border p-2 rounded bg-white/70";
div.innerHTML = `
  <div class="flex justify-between items-start mb-2">
    <div>
      <h3 class="font-semibold text-red-600">${s.series_description||s.modality||"Serie"}</h3>
      <div class="text-xs text-gray-600">M√©dico: ${s.medico_remitente||""} ‚Ä¢ Im√°genes: ${s.num_imagenes||0}</div>
    </div>
    <div>
      <button onclick="abrirDicomViewerConSerie(${s.id})" class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Ver</button>
    </div>
  </div>
  <div id="imagenes_${s.id}" class="series-scroll"></div>
`;
cont.appendChild(div);
      // cargar im√°genes de esta serie
      cargarImagenesSerie(s.id, estudioId, s);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las series";
    console.error(err);
  }
}

function cerrarModalSeries(){
  document.getElementById("modalSeries").classList.add("hidden");
}

/* util de fechas y nacimientos (copiado tal cual de tu c√≥digo) */
function formatFecha(fechaStr){
  if(!fechaStr) return "";
  const f = new Date(fechaStr);
  if(isNaN(f.getTime())) return fechaStr;
  const dia=("0"+f.getDate()).slice(-2);
  const mes=("0"+(f.getMonth()+1)).slice(-2);
  const anio=f.getFullYear();
  const h=("0"+f.getHours()).slice(-2);
  const m=("0"+f.getMinutes()).slice(-2);
  return `${dia}-${mes}-${anio} - ${h}:${m}`;
}
function formatNacimiento(fechaStr){
  if(!fechaStr) return "";
  const s = String(fechaStr).trim();
  if(/^\d{8}$/.test(s)){
    return `${s.slice(6,8)}-${s.slice(4,6)}-${s.slice(0,4)}`;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    return `${s.slice(8,10)}-${s.slice(5,7)}-${s.slice(0,4)}`;
  }
  if(/^\d{2}-\d{2}-\d{4}$/.test(s)) return s;
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const dia=("0"+d.getDate()).slice(-2);
    const mes=("0"+(d.getMonth()+1)).slice(-2);
    const anio=d.getFullYear();
    return `${dia}-${mes}-${anio}`;
  }
  return s;
}

function cargarMiniaturasEVO(imagenes) {
  const cont = document.getElementById("miniaturasSerie");
  cont.innerHTML = "";
  imagenes.forEach((imgObj, idx) => {
    const div = document.createElement("div");
    div.className = "miniatura-item";
    const src = imgObj.preview_base64 ? 
      `data:image/png;base64,${imgObj.preview_base64}` : 
      `${API_BASE}/imagen/${imgObj.id}?frame=0`;
    div.innerHTML = `<img src="${src}" alt="miniatura" />`;

    div.addEventListener("click", () => {
      mostrarImagenSerie(idx); // cambiar imagen principal

      // Quitar clase active de todas las miniaturas
      const items = cont.querySelectorAll(".miniatura-item");
      items.forEach(i => i.classList.remove("active"));

      // Agregar clase active a la miniatura clickeada
      div.classList.add("active");
    });

    // Por defecto, la primera miniatura activa
    if(idx === 0) div.classList.add("active");

    cont.appendChild(div);
  });
}
// ‚úÖ Exportar estudio en ZIP
async function exportarEstudio() {
  if (!estudioActual) {
    alert("No hay estudio cargado.");
    return;
  }

  const url = `${API_BASE}/exportar/${estudioActual}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error en la exportaci√≥n");

    const blob = await res.blob();
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `estudio_${estudioActual}.zip`;
    link.click();
  } catch (err) {
    console.error(err);
    alert("‚ùå No se pudo exportar el estudio");
  }
}

// ‚úÖ Abrir el input para seleccionar informe
function abrirInputInforme() {
  document.getElementById("inputInforme").click();
}

// ‚úÖ Subir informe
async function importarInforme(event) {
  if (!estudioActual) {
    alert("No hay estudio cargado.");
    return;
  }
  const file = event.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("informe", file);

  try {
    const res = await fetch(`${API_BASE}/importar_informe/${estudioActual}`, {
      method: "POST",
      body: formData
    });
    if (!res.ok) throw new Error("Error al subir el informe");

    await res.json();
    alert("‚úÖ Informe importado");
    cargarInformes(); // refrescar lista
  } catch (err) {
    console.error(err);
    alert("‚ùå No se pudo importar el informe");
  }
}

// ‚úÖ Cargar informes del estudio y mostrarlos
async function cargarInformes() {
  if (!estudioActual) return;

  try {
    const res = await fetch(`${API_BASE}/informes/${estudioActual}`);
    if (!res.ok) throw new Error("Error al cargar informes");
    const informes = await res.json();

    const area = document.getElementById(`informes-${estudioActual}`);
    area.innerHTML = "";

    if (informes.length === 0) {
      area.innerHTML = "<p>No hay informes.</p>";
      return;
    }

    informes.forEach(fname => {
      const card = document.createElement("div");
      card.className = "bg-gray-100 p-3 rounded shadow mb-2";

      const isPDF = fname.toLowerCase().endsWith(".pdf");

      card.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-semibold">üìÑ ${fname}</span>
          <div>
            <a href="${API_BASE}/informes/${estudioActual}/${fname}" target="_blank" 
               class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Ver</a>
            <a href="${API_BASE}/informes/${estudioActual}/${fname}" download
               class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700">Descargar</a>
          </div>
        </div>
        ${isPDF 
          ? `<iframe src="${API_BASE}/informes/${estudioActual}/${fname}" class="w-full h-64 mt-2 border"></iframe>`
          : `<pre class="bg-white p-2 rounded mt-2 text-sm">${fname}</pre>`}
      `;
      
      area.appendChild(card);
    });
  } catch (err) {
    console.error(err);
  }
}
 
/* Inicial: aplicamos transform para evitar NaN */
applyTransform();

/* ========== PAGINACI√ìN ========== */
let page = 0;
const limit = 50;

async function loadStudies() {
  try {
    const res = await fetch(`${API_BASE}/estudios?skip=${page * limit}&limit=${limit}`);
    if (!res.ok) throw new Error("Error al obtener estudios paginados");
    const data = await res.json();

    // Agregar estudios a la tabla
    const tbody = document.getElementById("tablaEstudios");
    data.forEach(e => renderEstudioConExpansion(e));

    // Si hay menos de 'limit', no hay m√°s p√°ginas
    if (data.length < limit) {
      document.getElementById("btnNext").disabled = true;
    } else {
      document.getElementById("btnNext").disabled = false;
    }
  } catch (err) {
    console.error(err);
    alert("Error cargando m√°s estudios");
  }
}

function nextPage() {
  page++;
  loadStudies();
}

function prevPage() {
  if (page > 0) {
    page--;
    loadStudies();
  }
}
document.addEventListener("DOMContentLoaded", () => {
  cargarEstudios();
});
function abrirModalViewer() {
  const modal = document.getElementById('dicomViewerModal');
  modal.classList.remove('hidden');
  setTimeout(() => modal.classList.add('show'), 50);
  document.getElementById('dicomViewerModal').classList.add('showing');
}

// === Fade al cerrar ===
function cerrarModalViewer() {
  const modal = document.getElementById('dicomViewerModal');
  modal.classList.remove('show');
  setTimeout(() => modal.classList.add('hidden'), 500);
}

// === Efecto borde azul al tocar la imagen ===
document.addEventListener('DOMContentLoaded', () => {
  const img = document.getElementById('dicomViewerImage');
  if (img) {
    img.addEventListener('click', () => {
      img.classList.toggle('active');
    });
  }
});
// Activa la animaci√≥n suave cuando se muestre el visor
  window.addEventListener('load', () => {
  const toolbar = document.getElementById('toolbar');
  setTimeout(() => {
    toolbar.classList.remove('opacity-0', '-translate-y-5');
    toolbar.classList.add('opacity-100', 'translate-y-0', 'scale-100', 'animate-glow');
  }, 300);
});
// Medir
document.getElementById('measureDropdownBtn').addEventListener('click', () => {
  const options = document.getElementById('measureOptions');
  options.classList.toggle('hidden');
});

// üéûÔ∏è --- CINE --- üéûÔ∏è
document.getElementById('cineBtn').addEventListener('click', () => {
  const options = document.getElementById('cineOptions');
  options.classList.toggle('hidden');
});

let cineInterval = null;
let cineFPS = 30;
let cineActivo = false;

function playCine() {
  if (cineActivo) return; // evita iniciar dos veces
  cineActivo = true;

  const thumbs = Array.from(document.querySelectorAll('#miniaturasSerie img'));
  if (thumbs.length === 0) {
    console.warn("No hay miniaturas cargadas para modo cine.");
    return;
  }

  let i = indiceImagenActual || 0;
  clearInterval(cineInterval);

  cineInterval = setInterval(() => {
    i = (i + 1) % thumbs.length;
    indiceImagenActual = i;

    // Mostrar imagen principal usando las miniaturas cargadas
    const mainImage = document.getElementById('dicomViewerImage');
    mainImage.src = thumbs[i].src;

    // Resaltar miniatura activa
    thumbs.forEach((thumb, idx) => {
      thumb.style.border = idx === i ? "3px solid #2563eb" : "1px solid #444";
    });

  }, 1000 / cineFPS);
}

function pauseCine() {
  cineActivo = false;
  clearInterval(cineInterval);
}

function increaseFPS() {
  cineFPS = Math.min(cineFPS + 5, 60);
  updateFPS();
}

function decreaseFPS() {
  cineFPS = Math.max(cineFPS - 5, 1);
  updateFPS();
}

function updateFPS() {
  document.getElementById('currentFPS').innerText = cineFPS + ' FPS';
  if (cineActivo) {
    pauseCine();
    playCine();
  }
}
let magnifierEnabled = false;
let magnifierDiv = null;
let zoomFactor = 2;
let activeMagnifier = false;

function toggleMagnifier() {
  magnifierEnabled = !magnifierEnabled;
  console.log(magnifierEnabled ? "üîç Lupa activada" : "‚ùå Lupa desactivada");

  const wrapper = document.getElementById("dicomImageWrapper");
  const img = document.getElementById("dicomViewerImage");

  if (!magnifierDiv) createMagnifier(wrapper, img);

  if (magnifierEnabled) {
    img.style.cursor = "crosshair";
    img.addEventListener("mousedown", startMagnifier);
    img.addEventListener("mousemove", moveMagnifier);
    img.addEventListener("mouseup", stopMagnifier);
    img.addEventListener("mouseleave", hideMagnifier);
  } else {
    img.style.cursor = "pointer";
    img.removeEventListener("mousedown", startMagnifier);
    img.removeEventListener("mousemove", moveMagnifier);
    img.removeEventListener("mouseup", stopMagnifier);
    img.removeEventListener("mouseleave", hideMagnifier);
    hideMagnifier();
  }
}

function createMagnifier(wrapper, img) {
  magnifierDiv = document.createElement("div");
  magnifierDiv.id = "magnifier";
  Object.assign(magnifierDiv.style, {
    position: "absolute",
    width: "180px",
    height: "180px",
    borderRadius: "50%",
    border: "2px solid #3b82f6",
    overflow: "hidden",
    pointerEvents: "none",
    display: "none",
    zIndex: "999",
    boxShadow: "0 0 20px rgba(59,130,246,0.6)",
  });

  const zoomed = document.createElement("img");
  zoomed.src = img.src;
  zoomed.style.position = "absolute";
  zoomed.style.transformOrigin = "top left";
  zoomed.style.userSelect = "none";
  zoomed.style.pointerEvents = "none";
  magnifierDiv.appendChild(zoomed);

  wrapper.appendChild(magnifierDiv);
}

function startMagnifier(e) {
  if (!magnifierEnabled) return;
  activeMagnifier = true;
  moveMagnifier(e);
  magnifierDiv.style.display = "block";
}

function stopMagnifier() {
  activeMagnifier = false;
  hideMagnifier();
}

function moveMagnifier(e) {
  if (!magnifierEnabled || !activeMagnifier) return;

  const img = document.getElementById("dicomViewerImage");
  const rect = img.getBoundingClientRect();
  const zoomed = magnifierDiv.querySelector("img");

  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const scale = zoomFactor;

  magnifierDiv.style.left = `${x - magnifierDiv.offsetWidth / 2}px`;
  magnifierDiv.style.top = `${y - magnifierDiv.offsetHeight / 2}px`;
  magnifierDiv.style.display = "block";

  zoomed.src = img.src; // sincroniza por si cambi√≥ la imagen
  zoomed.style.width = `${img.width * scale}px`;
  zoomed.style.height = `${img.height * scale}px`;
  zoomed.style.left = `${-x * scale + magnifierDiv.offsetWidth / 2}px`;
  zoomed.style.top = `${-y * scale + magnifierDiv.offsetHeight / 2}px`;
}

function hideMagnifier() {
  if (magnifierDiv) magnifierDiv.style.display = "none";
}

// Abrir calendario al hacer clic en el contenedor del input date
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll('.filtro-date-container').forEach(container => {
    container.addEventListener('click', function(e) {
      if (e.target.tagName !== 'BUTTON') { // Evitar abrir si hacen clic en el bot√≥n √ó
        const input = this.querySelector('input[type="date"]');
        if (input) {
          input.focus(); // Esto abre el calendario en la mayor√≠a de navegadores
        }
      }
    });
  });
});

</script>
</body>
</html>
