<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>DICOMTROL</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" />
<style>
html, body { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

#login-screen {
  min-height: 100vh;
  background: url("abstract-health-medical-science-healthcare-icon-digital-technology-science-concept-modern-innovation-treatment-medicine-on-hi-tech-future-blue-background-for-wallpaper-template-web-design-vector.jpg") no-repeat center center fixed;
  background-size: cover;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  animation: fadeIn 0.6s forwards;
}

.login-box {
  background: rgba(255, 255, 255, 0.45); /* más transparente */
  backdrop-filter: blur(12px);
  border-radius: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  padding: 2rem;
  width: 100%;
  max-width: 400px;
  transition: opacity 0.4s, transform 0.4s;
}

/* Logo DICOMTROL como texto */
.brand { 
  font-size: 2.0rem; 
  font-weight: 700; 
  letter-spacing: 1.2px; 
  color: #003366; /* azul oscuro */
  text-align: center; 
}
.brand span { 
  color: #fff; 
  background: #003366; 
  padding: 0 8px; 
  border-radius: 6px; 
}

/* Inputs estilo */
.login-box input {
  width: 100%;
  padding: 0.6rem 0.8rem;
  margin-bottom: 1rem;
  border: 2px solid rgba(0,0,0,0.2);
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.login-box input:focus {
  outline: none;
  border-color: #003366; /* azul al enfocar */
  box-shadow: 0 0 8px rgba(0,51,102,0.5);
}

/* Fade Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-15px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(-15px); }
}

#login-screen.fade-out {
  animation: fadeOut 0.5s forwards;
}

/* Botón */
.btn-red { background: #003366; transition: .2s; }
.btn-red:hover { background: #002244; }

/* --------- PANEL PRINCIPAL --------- */
#main-panel {
  min-height: 100vh;
  background: rgba(255,255,255,0.1)
    url("abstract-technology-science-concept-dna-futuristic-on-hi-tech-blue-background-vector.jpg")
    no-repeat center center fixed;
  background-size: cover;
  display: flex;
  flex-direction: column;
  opacity: 1;
  transition: opacity 0.6s ease-in-out;
}

#main-panel.visible {
  opacity: 1;
}

/* --------- TARJETAS (PANEL-CARD) --------- */
#main-panel {
  min-height: 100vh;
  background: rgba(255,255,255,0.08)
    url("abstract-technology-science-concept-dna-futuristic-on-hi-tech-blue-background-vector.jpg")
    no-repeat center center fixed;
  background-size: cover;
  display: flex;
  flex-direction: column;
  opacity: 1;
  transition: opacity 0.6s ease-in-out;
}

#main-panel.visible {
  opacity: 1;
}

/* --------- TARJETAS (PANEL-CARD) --------- */
.panel-card {
  position: relative;
  background: rgba(255,255,255,0.28);
  backdrop-filter: blur(20px) saturate(160%);
  border-radius: 18px;
  border: 1px solid rgba(0,180,255,0.4);
  box-shadow: 0 8px 25px rgba(0,0,0,0.35);
  padding: 24px;
  margin: 2rem;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  transition: all 0.3s ease;
}

/* Hover flotante */
.panel-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 15px 40px rgba(0,200,255,0.35);
}

/* --------- ANIMACIÓN DE BRILLO ENERGÉTICO --------- */
.panel-card::before {
  content: "";
  position: absolute;
  top: -3px;
  left: -3px;
  width: calc(100% + 6px);
  height: calc(100% + 6px);
  border-radius: 18px;
  background: linear-gradient(
    120deg,
    rgba(0,200,255,0.9),
    rgba(255,255,255,0.6),
    rgba(0,180,255,0.9)
  );
  background-size: 300% 300%;
  z-index: 1;
  opacity: 0.55;
  animation: bordeBrillante 3s linear infinite;
  filter: blur(1px);
  pointer-events: none;
}

@keyframes bordeBrillante {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Capa superior del contenido */
.panel-card > * {
  position: relative;
  z-index: 2;
}
/* --------- EFECTO DE ENCENDIDO AL MOSTRAR EL PANEL --------- */
#main-panel.visible::after {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, rgba(0,200,255,0.4), transparent 70%);
  pointer-events: none;
  opacity: 0;
  animation: encendidoBrillo 2.5s ease-out forwards;
  z-index: 100;
}

@keyframes encendidoBrillo {
  0% {
    opacity: 0.9;
    transform: scale(1.2);
    filter: blur(10px);
  }
  40% {
    opacity: 1;
    transform: scale(1);
    filter: blur(4px);
  }
  100% {
    opacity: 0;
    transform: scale(1);
    filter: blur(0);
  }
}
/* TABLE SCROLL FLOATER */
/* ====== TABLA PRINCIPAL (con contraste visual) ====== */
.tabla-wrapper {
  flex-grow: 1;
  overflow-y: auto;
  max-height: calc(100vh - 200px);
  border-radius: 14px;
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(8px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
  transition: all 0.3s ease;
  border: 1px solid rgba(255, 255, 255, 0.25);
}

table {
  width: 100%;
  border-collapse: collapse;
  overflow: hidden;
  min-width: 1000px;
  color: #fff;
  font-size: 0.95rem;
  letter-spacing: 0.3px;
}

/* ====== CABECERA ====== */
thead th {
  background: rgba(0, 34, 68, 0.85); /* Azul con opacidad */
  color: #eaf6ff;
  text-align: center;
  padding: 14px;
  font-weight: 600;
  text-shadow: 0 0 6px rgba(0, 180, 255, 0.6);
  border-bottom: 1px solid rgba(255,255,255,0.15);
  position: sticky;
  top: 0;
  z-index: 2;
  backdrop-filter: blur(10px);
  transition: background 0.3s ease, transform 0.2s ease;
}

/* Efecto hover en encabezado */
thead th:hover {
  background: rgba(0, 60, 120, 0.9);
  transform: scale(1.03);
}

/* ====== FILAS (más claras, blancas y legibles) ====== */
tbody td {
  text-align: center;
  padding: 12px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  color: #111; /* texto negro */
  background: rgba(255, 255, 255, 0.8); /* blanco con leve opacidad */
  backdrop-filter: blur(6px);
  transition: all 0.25s ease;
}

/* Alternancia de color más sutil */
tbody tr:nth-child(even) td {
  background: rgba(255, 255, 255, 0.9);
}

/* Hover elegante pero suave */
tbody tr:hover td {
  background: rgba(0, 123, 255, 0.15);
  color: #000;
  cursor: pointer;
  transform: scale(1.01);
  transition: all 0.25s ease;
}

/* ====== BOTONES DE PAGINACIÓN ====== */
#btnPrev, #btnNext {
  background: rgba(0, 123, 255, 0.25);
  color: #fff;
  border: 1px solid rgba(0, 123, 255, 0.5);
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  backdrop-filter: blur(6px);
}

#btnPrev:hover, #btnNext:hover {
  background: rgba(0, 123, 255, 0.4);
  box-shadow: 0 0 12px rgba(0, 123, 255, 0.6);
  transform: scale(1.05);
}

#btnPrev:active, #btnNext:active {
  transform: scale(0.95);
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
}

/* --------- MODALES CON TRANSPARENCIA --------- */
.modal-bg { 
  background: rgba(0,0,0,0.55); 
  backdrop-filter: blur(6px); 
}
.modal-card { 
  background: rgba(255,255,255,0.86); 
  backdrop-filter: blur(10px); 
  border-radius: 1rem; 
  padding: 1rem; 
  max-width: 90%; 
  width: 100%; 
  overflow-y: auto; 
  max-height: 90vh; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.25); 
}

/* VISOR */
#visorModal .card { display: flex; gap: 1rem; align-items: flex-start; flex-wrap: wrap; }
#visorModal img { max-width: 720px; max-height: 80vh; border-radius: 8px; }
#visorMeta { min-width: 320px; max-width: 420px; overflow:auto; }

/* SERIES SCROLL HORIZONTAL */
.series-scroll {
  display: flex;
  overflow-x: auto;
  gap: 8px;
  padding: 8px 0;
  scroll-snap-type: x mandatory;
}
.series-item {
  flex: 0 0 auto;
  scroll-snap-align: start;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  overflow: hidden;
  width: 160px;
  height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #eee;
}
.series-item img {
  max-width: 100%;
  max-height: 100%;
  object-fit: cover;
}

/* SERIES VERTICAL SCROLL (contenedor de series) */
#seriesContainer { max-height: 70vh; overflow-y: auto; padding-right: 8px; }

/* Botón Exportar pequeño junto a la burbuja de usuario */
.btn-export-small {
  height: 40px;
  padding-left: 10px;
  padding-right: 12px;
  font-size: 0.875rem;
  border-radius: 9999px;
}

/* -------- VISOR DICOM (EVO style mejorado) -------- */
#dicomViewerModal { z-index: 70; }
#dicomViewerCard {
  max-width: 90vw;
  height: 95vh;
  background: rgba(0,34,66,0.74);
  border-radius: 12px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  position: relative;
  margin: 0 auto;
}
#dicomViewerCard.expanded {
  position: fixed;
  inset: 0;
  width: 100%;
  height: 100%;
  max-width: none;
  border-radius: 0;
  padding: 18px;
}
#dicomViewerCard .area {
  display:flex; flex:1; gap:12px; min-height:0;
}
#dicomCanvas {
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  background:#001f3f;
  border-radius:8px;
  position:relative;
  overflow:hidden;
}

/* wrapper (transform applied here so overlay sigue alineada) */
#dicomImageWrapper {
  position: relative;
  width: 100%;
  height: 100%;
  display:flex;
  align-items:center;
  justify-content:center;
  transform-origin:center center;
}

/* imagen */
#dicomViewerImage {
  max-width: 95%;
  max-height: calc(100vh - 220px);
  object-fit: contain;
  transition: transform 0.08s ease, filter 0.1s ease;
  user-select: none;
  pointer-events: none;
}

/* overlay svg para medidas */
#overlaySvg {
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  pointer-events:auto;
}

/* sidebar de metadata: fondo negro y letras azules */
#dicomInfoPanel {
  width: 300px;
  background: rgba(0,0,0,0.95);
  color: #3399ff;
  padding: 14px;
  border-radius: 8px;
  overflow-y:auto;
}
#dicomInfoPanel h3 { color: #66ccff; }

/* botones de herramientas circulares */
.tool-btn {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: rgba(0,51,102,0.95);
  color: white;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.15s;
  box-shadow: 0 6px 18px rgba(0,0,0,0.45);
}
.tool-btn:hover { transform: scale(1.05); }

/* controles inferiores y navegación */
.viewer-controls {
  position:absolute;
  bottom:18px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:10px;
}
.viewer-nav {
  position:absolute;
  bottom:18px;
  right:18px;
  display:flex;
  gap:10px;
}

/* visual styles for measurements */
.measure-line { stroke: #00ccff; stroke-width: 3; stroke-linecap:round; }
.measure-dot { fill:#00ccff; stroke:#000; stroke-width:1; r:4; }
.measure-text { fill:#00ccff; font-size:14px; font-weight:700; text-shadow:0 1px 3px rgba(0,0,0,0.6); }

/* responsive tweaks */
@media (max-width: 900px){
  #dicomViewerCard { max-width: 98vw; height: 92vh; }
  #dicomInfoPanel { width: 220px; }
}

#miniaturasSerie {
  background-color: #001f3f;
  padding: 5px;
  overflow-y: auto;
  height: 100%;
}

.miniatura-item {
  margin-bottom: 5px;
  border: 2px solid transparent;
  cursor: pointer;
  transition: border 0.2s;
}

.miniatura-item img {
  display: block;
  width: 100%;
  object-fit: cover;
}

.miniatura-item.active {
  border: 2px solid #003366;
}
.fila-expandida td {
  background: #fff;
  padding: 0;
  border: none;
}

.panel-opciones {
  padding: 10px;
  background: white;
  border: 1px solid #003366;
  border-left: 5px solid #003366;
  border-radius: 4px;
  animation: slideDown 0.3s ease;
}

.panel-opciones div {
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.panel-opciones .btn-icon {
  background: #003366;
  color: white;
  border: none;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  transition: background 0.2s;
}

.panel-opciones .btn-icon:hover {
  background: #002244;
}

@keyframes expandSlide {
  from {
    opacity: 0;
    transform: translateX(-15px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}
@keyframes slideDown {
  from { transform: scaleY(0); opacity: 0; }
  to { transform: scaleY(1); opacity: 1; }
}
/* ====== CONTENEDOR DE FILTROS ====== */
.filtros-container {
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(10px);
  border-radius: 12px;
  padding: 14px 18px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* ====== CAMPOS ====== */
.filtro-input, .filtro-select {
  background: rgba(255, 255, 255, 0.65);
  color: #002244;
  border: 1px solid rgba(0,0,0,0.15);
  padding: 10px 14px;
  border-radius: 8px;
  transition: all 0.3s ease;
  backdrop-filter: blur(6px);
  font-size: 0.95rem;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
}

.filtro-input::placeholder {
  color: rgba(0,0,0,0.5);
}

.filtro-input:focus, .filtro-select:focus {
  border-color: #007BFF;
  box-shadow: 0 0 10px rgba(0,123,255,0.4);
  outline: none;
  background: rgba(255,255,255,0.9);
  color: #001933;
}


/* ====== BOTÓN RECARGAR ====== */
.btn-filtro {
  background: rgba(0,123,255,0.25);
  color: #fff;
  border: 1px solid rgba(0,123,255,0.6);
  border-radius: 10px;
  padding: 11px 20px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s ease;
  backdrop-filter: blur(8px);
  letter-spacing: 0.3px;
  text-shadow: 0 0 4px rgba(255,255,255,0.3);
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn-filtro:hover {
  background: rgba(0,123,255,0.4);
  box-shadow: 0 0 14px rgba(0,123,255,0.7);
  transform: scale(1.07);
}

.btn-filtro:active {
  transform: scale(0.97);
  box-shadow: 0 0 6px rgba(0,123,255,0.4);
}

/* ====== ICONO DE RECARGAR ANIMADO ====== */
.icono-recargar {
  display: inline-block;
  transition: transform 0.4s ease;
}

.btn-filtro:hover .icono-recargar {
  transform: rotate(360deg);
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
<!-- Toast (solo una vez en toda la app) -->
  <div id="toast" 
       class="fixed bottom-5 right-5 bg-green-600 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-500">
    ✅ Enlace copiado al portapapeles
  </div>
<!-- SCRIPT de cierre de login -->
<script>
function cerrarLogin() {
  const login = document.getElementById('login-screen');
  const main = document.getElementById('main-panel');

  // Añade la clase fade-out al login
  login.classList.add('fade-out');

  // Espera a que termine la animación antes de ocultar y mostrar panel
  setTimeout(() => {
    login.style.display = 'none';
    main.style.display = 'block';
  }, 500); // 500ms = duración de fade-out
}
async function recargarConAnimacion() {
  const icono = document.querySelector('.icono-recargar');
  icono.classList.add('spin');

  try {
    await cargarEstudios(); // tu función ya existente
  } finally {
    setTimeout(() => icono.classList.remove('spin'), 1000);
  }
}
</script>
<body>

<!-- LOGIN -->
<section id="login-screen" class="flex items-center justify-center">
  <div class="login-box">
    <div class="mb-4 flex flex-col items-center">
      <div class="brand"><span>DICOM</span>TROL</div>
    </div>

    <label class="block text-gray-700 font-medium">Usuario</label>
    <input id="username" class="w-full px-3 py-2 mb-4 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="text" placeholder="admin" />

    <label class="block text-gray-700 font-medium">Contraseña</label>
    <input id="password" class="w-full px-3 py-2 mb-6 border rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-red-400" type="password" placeholder="clave123" />

    <button onclick="login()" class="w-full btn-red text-white py-2 rounded-lg shadow-md">Iniciar Sesión</button>
    <p id="loginError" class="text-red-600 text-center mt-4 hidden">Credenciales incorrectas</p>
  </div>
</section>

<!-- PANEL PRINCIPAL -->
<section id="main-panel">
  <div class="panel-card">
    <!-- HEADER -->
<div class="flex justify-between items-center mb-6">
  <div class="flex items-center gap-2">
    <div class="brand"><span>DICOM</span>TROL</div>
  </div>

  <div class="flex items-center gap-3">
        <!-- BOTÓN EXPORTAR (pequeño, igual altura que burbuja) -->
        <button id="btnExportar" class="btn-export-small flex items-center gap-2 px-3 bg-gradient-to-r from-blue-600 via-blue-500 to-blue-700 text-white font-semibold shadow-md hover:shadow-lg transition transform active:translate-y-0">
          <span style="font-size:16px">📩​​</span>
          <span style="font-size:13px">Exportar</span>
        </button>

    <!-- BURBUJA USUARIO -->
    <div class="relative">
      <div class="flex items-center justify-center w-20 h-10 bg-blue-600 rounded-full shadow-md">
      </div>
      <span class="absolute inset-0 flex items-center justify-center text-white font-semibold text-sm">
        admin
      </span>
    </div>
  </div>
</div>

<!-- POPUP EXPORTAR -->
<div id="popupExportar" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl shadow-lg p-6 w-80">
    <h2 class="text-lg font-semibold mb-4 text-gray-800">Exportar Lista de Estudios</h2>
    <p class="text-sm text-gray-600 mb-4">Selecciona el rango de tiempo que deseas exportar:</p>

    <div class="space-y-3">
      <button class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
        onclick="exportarEstudios('hoy')">Hoy</button>
      <button class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
        onclick="exportarEstudios('semanal')">Semanal</button>
      <button class="w-full px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
        onclick="exportarEstudios('mensual')">Mensual</button>
    </div>

    <div class="flex justify-end mt-4">
      <button onclick="cerrarPopup()" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition">
        Cancelar
      </button>
    </div>
  </div>
</div>

<script>
  // Mostrar popup
  document.getElementById("btnExportar").addEventListener("click", () => {
    document.getElementById("popupExportar").classList.remove("hidden");
  });

  // Cerrar popup
  function cerrarPopup() {
    document.getElementById("popupExportar").classList.add("hidden");
  }

  // Llamada al backend
  async function exportarEstudios(rango) {
      try {
        const response = await fetch(`${API_BASE}/exportar?rango=${rango}`, {
          method: "GET"
        });

        if (!response.ok) {
          throw new Error("Error al exportar los estudios");
        }

        // Descargar el archivo Excel
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `estudios_${rango}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

        cerrarPopup();
      } catch (error) {
        alert("Hubo un problema: " + error.message);
      }
    }
  </script>

 <!-- FILTROS Y BUSCADOR -->
<div class="filtros-container flex flex-col md:flex-row items-center gap-4 mb-4 w-full">
  <input id="search" 
         type="text" 
         placeholder="Buscar por nombre, ID o fecha…" 
         class="filtro-input flex-1 w-full md:w-auto"
         oninput="aplicarFiltros()">

  <select id="filterEstado" class="filtro-select" onchange="aplicarFiltros()">
    <option value="">Todos los Estados</option>
    <option value="Pendiente">Pendiente</option>
    <option value="Visto">Visto</option>
  </select>

  <select id="filterMedico" class="filtro-select" onchange="aplicarFiltros()">
    <option value="">Todos los Médicos</option>
  </select>

  <select id="filterNumImagenes" class="filtro-select" onchange="aplicarFiltros()">
    <option value="">Todas las cantidades</option>
    <option value="1">1 Imagen</option>
    <option value="2">2 Imágenes</option>
    <option value="3">3 Imágenes</option>
    <option value="4">4+</option>
  </select>

  <button id="btnRecargar" class="btn-filtro flex items-center gap-2" onclick="recargarConAnimacion()">
    <span class="icono-recargar">🔄</span>
    <span>Recargar</span>
  </button>
</div>

    <!-- TABLA -->
    <div class="tabla-wrapper overflow-auto flex-1">
      <table>
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Fecha Llegada</th>
            <th>Nacimiento</th>
            <th>Descripción</th>
            <th>ID Paciente</th>
            <th>Institución</th>
            <th># Imágenes</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="tablaEstudios"></tbody>
      </table>
<!-- Controles de paginación -->
<div class="flex justify-center mt-4 gap-2">
  <button id="btnPrev" onclick="prevPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">
    ⬅ Anterior
  </button>
  <button id="btnNext" onclick="nextPage()" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">
    Siguiente ➡
  </button>
</div>
    </div>
  </div>
</section>

<!-- MODAL SERIES -->
<div id="modalSeries" class="hidden fixed inset-0 z-40 flex items-start justify-center modal-bg pt-20">
  <div class="modal-card relative max-w-6xl w-full">
    <div class="absolute top-2 right-2 flex gap-2">
      <button onclick="cerrarModalSeries()" class="px-3 py-1 rounded bg-gray-600 text-white hover:bg-gray-700">Cerrar</button>
    </div>
    <h2 class="text-xl font-bold text-red-700 mb-4">Series del Estudio</h2>
    <div id="seriesContainer" class="space-y-4"></div>
  </div>
</div>

<div id="visorModal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg p-6">
  <div class="modal-card relative max-w-7xl w-full">
    <button onclick="cerrarVisor()" class="absolute top-3 right-3 px-3 py-1 rounded bg-red-600 text-white hover:bg-red-700">Cerrar</button>
    <div class="card p-4 flex flex-col md:flex-row gap-4">
      <div id="visorImageContainer" class="flex-1 flex items-center justify-center">
        <img id="visorImage" src="" alt="Imagen grande"/>
      </div>
      <div id="visorMeta" class="p-4 border-l">
        <h3 id="metaNombre" class="font-bold text-lg text-red-700 mb-2"></h3>
        <div id="metaBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- VISOR DICOM EVO STYLE -->
<div id="dicomViewerModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg p-6">
  <div id="dicomViewerCard" class="relative">
    <!-- expand + close -->
    <div style="position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:20;">
      <button id="expandBtn" onclick="toggleExpandViewer()" title="Expandir/Restaurar" class="w-10 h-10 rounded-full bg-gray-700 text-white flex items-center justify-center">⤢</button>
      <button onclick="cerrarModalViewer()" title="Cerrar" class="w-10 h-10 rounded-full bg-red-600 text-white flex items-center justify-center">✕</button>
    </div>

    <div class="area">
  <!-- MINIATURAS VERTICALES -->
  <div id="miniaturasSerie" class="flex flex-col gap-2 overflow-y-auto" style="width: 120px; max-height: 100%;">
    <!-- Miniaturas se cargarán dinámicamente aquí -->
  </div>

  <!-- Lienzo / imagen -->
  <div id="dicomCanvas" class="flex-1 flex items-center justify-center">
    <div id="dicomImageWrapper">
      <img id="dicomViewerImage" src="https://via.placeholder.com/1200x900?text=DICOM" alt="DICOM" draggable="false"/>
      <svg id="overlaySvg" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
  </div>

      <!-- Panel info -->
      <div id="dicomInfoPanel" class="ml-3">
        <h3>📋 Información</h3>
        <div id="dicomInfo" class="mt-2">
          <p><b>Paciente:</b> --</p>
          <p><b>ID:</b> --</p>
          <p><b>Fecha:</b> --</p>
          <p><b>Serie:</b> --</p>
          <p><b>Médico:</b> --</p>
        </div>
      </div>
    </div>

    <!-- controles (centro abajo) -->
    <div class="viewer-controls" aria-hidden="false">
      <button class="tool-btn" onclick="activateTool('Zoom')" title="Zoom">🔍</button>
      <button class="tool-btn" onclick="activateTool('Pan')" title="Pan">✋</button>
      <button class="tool-btn" onclick="activateTool('Wwwc')" title="Brillo/Contraste">☀️</button>
      <button class="tool-btn" onclick="activateTool('Length')" title="Medir distancia">📏</button>
      <button class="tool-btn" onclick="activateTool('Area')" title="Medir área">⬛</button>
      <button class="tool-btn" onclick="resetView()" title="Reset">↺</button>
    </div>

    <!-- navegación -->
    <div class="viewer-nav">
      <button onclick="cambiarImagen(-1)" class="w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center text-xl">⟨</button>
      <button onclick="cambiarImagen(1)" class="w-12 h-12 rounded-full bg-red-600 text-white flex items-center justify-center text-xl">⟩</button>
    </div>
  </div>
</div>

<script>
const API_BASE = "https://visor-dicom-backend.onrender.com";

/* ========== GLOBALS ========== */
let imagenesSerieActual = [];
let indiceImagenActual = 0;
let estudios = [];
let estudiosFiltrados = [];

/* Transform/visual state */
const wrapper = () => document.getElementById('dicomImageWrapper');
const imgEl = () => document.getElementById('dicomViewerImage');
const overlay = () => document.getElementById('overlaySvg');

let state = {
  scale: 1,
  translateX: 0,
  translateY: 0,
  brightness: 1,
  contrast: 1,
  tool: null,
  dragging: false,
  dragStart: {x:0,y:0},
  panStart: {x:0,y:0},
  measurePts: [], // for length/area
  currentShape: null
};

/* ========== UTILS ========== */
function applyTransform() {
  const w = wrapper();
  w.style.transform = `translate(${state.translateX}px, ${state.translateY}px) scale(${state.scale})`;
  const img = imgEl();
  img.style.filter = `brightness(${state.brightness}) contrast(${state.contrast})`;
}

/* Reset view */
function resetView() {
  state.scale = 1;
  state.translateX = 0;
  state.translateY = 0;
  state.brightness = 1;
  state.contrast = 1;
  clearOverlays();
  applyTransform();
}

/* Toggle expand */
function toggleExpandViewer() {
  const card = document.getElementById('dicomViewerCard');
  card.classList.toggle('expanded');
  // forzar imagen a ocupar todo el espacio disponible
  imgEl().style.width = "100%";
  imgEl().style.height = "100%";
  imgEl().style.objectFit = "contain"; // mantiene proporción
}

/* ========== OPEN/CLOSE VISOR ========== */
function cerrarModalViewer() {
  const modal = document.getElementById("dicomViewerModal");
  modal.classList.add("hidden");
  imgEl().src = "";
  // NO tocar dicomInfo aquí
  resetView();
}

/* ========== TOOL ACTIVATION ========== */
function activateTool(toolName) {
  // clear measurement state on tool change
  state.tool = toolName;
  state.measurePts = [];
  removeCurrentSVGShape();
  // show tool in console for debugging
  console.log('Herramienta activa:', toolName);
}

/* ========== WHEEL (zoom / wwwc) ========== */
document.getElementById('dicomImageWrapper').addEventListener('wheel', function(e){
  // get mounted tool
  if(!state.tool) return;
  if(state.tool === 'Zoom') {
    e.preventDefault();
    const delta = (e.deltaY < 0) ? 1.08 : 0.925;
    // zoom toward cursor: adjust translate so it zooms to pointer
    const rect = wrapper().getBoundingClientRect();
    const cx = e.clientX - rect.left;
    const cy = e.clientY - rect.top;
    // compute offset before scale
    const prevScale = state.scale;
    state.scale = Math.max(0.2, Math.min(8, state.scale * delta));
    // adjust translate to keep point under cursor stable
    state.translateX = (state.translateX - cx) * (state.scale / prevScale) + cx;
    state.translateY = (state.translateY - cy) * (state.scale / prevScale) + cy;
    applyTransform();
  } else if (state.tool === 'Wwwc') {
    e.preventDefault();
    // adjust brightness with wheel
    const change = -e.deltaY * 0.0015;
    state.brightness = Math.max(0.2, Math.min(3, state.brightness + change));
    // optionally change contrast a bit too:
    state.contrast = Math.max(0.2, Math.min(3, state.contrast + change*0.6));
    applyTransform();
  }
}, { passive: false });

/* ========== PAN (drag) ========== */
document.getElementById('dicomImageWrapper').addEventListener('pointerdown', function(e){
  if (state.tool === 'Pan') {
    state.dragging = true;
    state.dragStart = { x: e.clientX, y: e.clientY };
    state.panStart = { x: state.translateX, y: state.translateY };
    document.body.style.cursor = 'grabbing';
    e.preventDefault();
  }
});
window.addEventListener('pointermove', function(e){
  if (state.dragging && state.tool === 'Pan') {
    const dx = e.clientX - state.dragStart.x;
    const dy = e.clientY - state.dragStart.y;
    state.translateX = state.panStart.x + dx;
    state.translateY = state.panStart.y + dy;
    applyTransform();
  }
});
window.addEventListener('pointerup', function(){
  if(state.dragging) {
    state.dragging = false;
    document.body.style.cursor = 'default';
  }
});

/* ========== MEASUREMENT (Length & Area) ========== */
function clearOverlays() {
  const sv = overlay();
  while (sv.firstChild) sv.removeChild(sv.firstChild);
  state.measurePts = [];
  state.currentShape = null;
}
function removeCurrentSVGShape(){
  if(state.currentShape && state.currentShape.parentNode) {
    state.currentShape.parentNode.removeChild(state.currentShape);
    state.currentShape = null;
  }
}

/* helper: create SVG elements */
function svgLine(x1,y1,x2,y2, cls='measure-line') {
  const ns = 'http://www.w3.org/2000/svg';
  const line = document.createElementNS(ns, 'line');
  line.setAttribute('x1', x1);
  line.setAttribute('y1', y1);
  line.setAttribute('x2', x2);
  line.setAttribute('y2', y2);
  line.setAttribute('class', cls);
  return line;
}
function svgCircle(cx,cy,r=4, cls='measure-dot') {
  const ns = 'http://www.w3.org/2000/svg';
  const c = document.createElementNS(ns, 'circle');
  c.setAttribute('cx', cx);
  c.setAttribute('cy', cy);
  c.setAttribute('r', r);
  c.setAttribute('class', cls);
  return c;
}
function svgText(x,y,text, cls='measure-text') {
  const ns = 'http://www.w3.org/2000/svg';
  const t = document.createElementNS(ns, 'text');
  t.setAttribute('x', x);
  t.setAttribute('y', y);
  t.setAttribute('class', cls);
  t.textContent = text;
  return t;
}
function svgPolygon(pointsStr, cls='measure-line') {
  const ns = 'http://www.w3.org/2000/svg';
  const p = document.createElementNS(ns, 'polygon');
  p.setAttribute('points', pointsStr);
  p.setAttribute('fill', 'rgba(0,255,200,0.08)');
  p.setAttribute('stroke', '#00ffd1');
  p.setAttribute('stroke-width','2');
  return p;
}

/* distance between two points */
function dist(p1,p2) {
  const dx = p1.x - p2.x;
  const dy = p1.y - p2.y;
  return Math.sqrt(dx*dx + dy*dy);
}

/* compute polygon area (signed) */
function polygonArea(points) {
  let area = 0;
  for (let i=0;i<points.length;i++){
    const j = (i+1)%points.length;
    area += points[i].x * points[j].y - points[j].x * points[i].y;
  }
  return Math.abs(area / 2);
}

/* click handling for measurements */
document.getElementById('dicomImageWrapper').addEventListener('click', function(e){
  const tool = state.tool;
  if(!tool) return;
  // get click coords relative to wrapper
  const rect = wrapper().getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  if(tool === 'Length') {
    // push point
    state.measurePts.push({x,y});
    redrawMeasures();
    if(state.measurePts.length === 2) {
      // finalize: compute distance and show text
      const a = state.measurePts[0], b = state.measurePts[1];
      const d = dist(a,b).toFixed(1); // pixels
      const mid = { x: (a.x+b.x)/2, y: (a.y+b.y)/2 };
      overlay().appendChild(svgText(mid.x+6, mid.y-6, `${d}px`));
      // keep points on screen until tool reset or next action
      state.measurePts = []; // reset for new measure
    }
  } else if(tool === 'Area') {
    // accumulate points until double click to close (double click event handled below)
    state.measurePts.push({x,y});
    redrawMeasures();
  } else {
    // other tools ignored for clicks
  }
});

/* double click => finish polygon */
document.getElementById('dicomImageWrapper').addEventListener('dblclick', function(e){
  if(state.tool !== 'Area') return;
  if(state.measurePts.length < 3) {
    // not enough points
    return;
  }
  // compute area
  const areaPx = polygonArea(state.measurePts).toFixed(1);
  // draw final polygon and label
  const pointsStr = state.measurePts.map(p => `${p.x},${p.y}`).join(' ');
  overlay().appendChild(svgPolygon(pointsStr));
  // label near centroid
  const cx = state.measurePts.reduce((s,p)=>s+p.x,0)/state.measurePts.length;
  const cy = state.measurePts.reduce((s,p)=>s+p.y,0)/state.measurePts.length;
  overlay().appendChild(svgText(cx+6, cy-6, `${areaPx} px²`));
  // clear accumulation
  state.measurePts = [];
});

/* redraw measure preview (live) */
function redrawMeasures() {
  const sv = overlay();
  // clear only shapes created for preview (we'll wipe all and re-add persistent ones)
  while (sv.firstChild) sv.removeChild(sv.firstChild);
  // draw points
  for(let i=0;i<state.measurePts.length;i++){
    const p = state.measurePts[i];
    sv.appendChild(svgCircle(p.x,p.y,3));
    if(i>0){
      const prev = state.measurePts[i-1];
      sv.appendChild(svgLine(prev.x,prev.y,p.x,p.y));
    }
  }
}

/* ========== IMAGE LOADING & METADATA ========== */
async function abrirDicomViewerConSerie(serieId){
  try{
    document.getElementById("modalSeries").classList.add("hidden");
    document.getElementById("dicomViewerModal").classList.remove("hidden");

    // Cargar imágenes de la serie
    const res = await fetch(`${API_BASE}/series/${serieId}/imagenes`);
    if(!res.ok) throw new Error("No se pudieron cargar las imágenes de la serie");
    const imagenes = await res.json();
    if(imagenes.length === 0) throw new Error("Serie sin imágenes");

    // ✅ Asignar imagenes y mostrar primera imagen
    imagenesSerieActual = imagenes;
    indiceImagenActual = 0;
    mostrarImagenSerie(indiceImagenActual);

    // ✅ Cargar miniaturas en la columna lateral
    cargarMiniaturasEVO(imagenes);

    // ✅ Resetear vista
    resetView();
  }catch(err){
    alert("No se pudo abrir el visor DICOM: " + err.message);
    console.error(err);
  }
}
/* mostrar imagen y metadata */
async function mostrarImagenSerie(indice) {
  if (indice < 0 || indice >= imagenesSerieActual.length) return;

  indiceImagenActual = indice;
  const imgObj = imagenesSerieActual[indice];

  // Marcar miniatura activa
  document.querySelectorAll("#miniaturasSerie img").forEach((thumb, i) => {
    thumb.style.border = i === indice ? "3px solid red" : "1px solid #ccc";
  });

  // Mostrar imagen grande
  const dicomImg = document.getElementById("dicomViewerImage");
  dicomImg.src = imgObj.preview_base64
    ? `data:image/png;base64,${imgObj.preview_base64}`
    : `${API_BASE}/imagen/${imgObj.id}?frame=0`;

  // --- Obtener estudio completo ---
  let estudio = {};
  try {
    const resEst = await fetch(`${API_BASE}/estudios/${imgObj.estudio_id}`);
    if (resEst.ok) estudio = await resEst.json();
  } catch (err) {
    console.error("Error cargando estudio:", err);
  }

  // --- Obtener serie completa ---
  let serie = {};
  try {
    const resSer = await fetch(`${API_BASE}/series/${imgObj.serie_id}`);
    if (resSer.ok) serie = await resSer.json();
  } catch (err) {
    console.error("Error cargando serie:", err);
  }

  // --- Actualizar panel lateral ---
  document.getElementById("dicomInfo").innerHTML = `
    <p><b>Paciente:</b> ${estudio?.nombre || imgObj.paciente || imgObj.paciente_nombre || "--"}</p>
    <p><b>ID:</b> ${estudio?.paciente_id || imgObj.paciente_id || imgObj.patient_id || "--"}</p>
    <p><b>Fecha Nac.:</b> ${formatNacimiento(estudio?.nacimiento) || "--"}</p>
    <p><b>Fecha Estudio:</b> ${formatFecha(estudio?.fecha) || imgObj.fecha || imgObj.study_date || "--"}</p>
    <p><b>Fecha Llegada:</b> ${formatFecha(estudio?.created_at) || "--"}</p>
    <p><b>Institución:</b> ${estudio?.institucion || "--"}</p>
    <hr/>
    <p><b>Serie:</b> ${serie?.series_description || imgObj.serie_descripcion || imgObj.series_description || "--"}</p>
    <p><b>Parte cuerpo:</b> ${serie?.body_part || "--"}</p>
    <p><b>Médico remitente:</b> ${serie?.medico_remitente || imgObj.medico || imgObj.medico_remitente || "--"}</p>
  `;

  clearOverlays();
}

/* ========== NAVIGATION ========== */
function cambiarImagen(direccion){
  indiceImagenActual += direccion;
  if(indiceImagenActual < 0) indiceImagenActual = 0;
  if(indiceImagenActual >= imagenesSerieActual.length) indiceImagenActual = imagenesSerieActual.length - 1;
  mostrarImagenSerie(indiceImagenActual);
}

/* ========== VISOR MINIATURAS (series) ========== */
async function cargarImagenesSerie(serieId, estudioId, serieObj){
  const cont=document.getElementById(`imagenes_${serieId}`);
  cont.innerHTML="Cargando imágenes...";
  try{
    const res=await fetch(`${API_BASE}/series/${serieId}/imagenes`);
    if(!res.ok) throw new Error("no imagenes");
    const imagenes = await res.json();
    cont.innerHTML="";
    for(const img of imagenes){
      const imgElem=document.createElement("div");
      imgElem.className="series-item";
      const src = img.preview_base64 ? `data:image/png;base64,${img.preview_base64}` : `${API_BASE}/imagen/${img.id}?frame=0`;
      imgElem.innerHTML=`<img id="img_${img.id}" src="${src}" onclick="abrirVisor(${img.id}, ${estudioId}, ${serieId})" alt="miniatura" style="max-width:100%; max-height:100%; object-fit:cover;"/>`;
      cont.appendChild(imgElem);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las imágenes";
    console.error(err);
  }
}

/* abrir visor simple (visorModal) para miniatura grande */
async function abrirVisor(imagenId, estudioId, serieId) {
  try {
    const visorImg = document.getElementById("dicomViewerImage");
    visorImg.src = `${API_BASE}/imagen/${imagenId}`;

    // Llamar a mostrarImagenSerie para actualizar metadata lateral automáticamente
    const indice = imagenesSerieActual.findIndex(i => i.id === imagenId);
    if (indice >= 0) await mostrarImagenSerie(indice);

    document.getElementById("dicomViewerModal").classList.remove("hidden");
  } catch (err) {
    alert("No se pudo abrir visor");
    console.error(err);
  }
}

/* ========== CERRAR VISOR ========== */
function cerrarModalViewer() {
  const modal = document.getElementById("dicomViewerModal");
  modal.classList.add("hidden");
  document.getElementById("dicomViewerImage").src = "";
  document.getElementById("dicomInfo").innerHTML = `
    <p><b>Paciente:</b> --</p>
    <p><b>ID:</b> --</p>
    <p><b>Fecha Nac.:</b> --</p>
    <p><b>Fecha Estudio:</b> --</p>
    <p><b>Fecha Llegada:</b> --</p>
    <p><b>Institución:</b> --</p>
    <p><b>Serie:</b> --</p>
    <p><b>Parte cuerpo:</b> --</p>
    <p><b>Médico remitente:</b> --</p>`;
  resetView();
}

function cerrarVisor(){
  document.getElementById("visorModal").classList.add("hidden");
  document.getElementById("visorImage").src = "";
}

/* ========== OTRAS FUNCIONES (login, cargarEstudios, filtros...) ========== */
// Copié y mantuve el resto de tu lógica para login, carga de estudios y filtros exactamente igual
// (para ahorro de espacio no repito funciones largas que ya existían arriba en tu código;
// en caso de que quieras que reinserté TODO exactamente línea por línea, lo hago también).

async function login() {
  const usuario = document.getElementById("username").value;
  const clave = document.getElementById("password").value;
  const loginScreen = document.getElementById("login-screen");
  const mainPanel = document.getElementById("main-panel");

  if (usuario === "admin" && clave === "clave123") {
    // Fade-out login
    loginScreen.classList.add("fade-out");

    setTimeout(() => {
      loginScreen.style.display = "none";

      // Mostrar panel principal y hacer fade-in
      mainPanel.style.display = "flex";
      mainPanel.classList.add("visible");

      // Llamar a la función async que carga estudios
      cargarEstudios(); 

    }, 500); // duración de fade-out
  } else {
    document.getElementById("loginError").classList.remove("hidden");
  }
}

// Renderizado de filas con expansión
function renderEstudioConExpansion(estudio) {
  const tbody = document.getElementById("tablaEstudios");

  const tr = document.createElement("tr");
  tr.classList.add("fila-estudio");
  tr.innerHTML = `
    <td>${estudio.nombre || "--"}</td>
    <td>${estudio.fecha || "--"}</td>
    <td>${estudio.nacimiento || "--"}</td>
    <td>${estudio.descripcion || "--"}</td>
    <td>${estudio.paciente_id || "--"}</td>
    <td>${estudio.institucion || "--"}</td>
    <td>${estudio.num_imagenes || 0}</td>
    <td class="estado-col">${estudio.estado || "Pendiente"}</td>
    <td><button class="btn-ver" onclick="abrirVisorDesdeTabla(${estudio.id})">Ver</button></td>
  `;

  const panel = document.createElement("tr");
  panel.classList.add("fila-expandida");
  panel.style.display = "none";
  panel.innerHTML = `
  <td colspan="9">
    <div class="panel-opciones">
      <div>
        <span>Estado de Estudio:</span>
        <span class="icono-ojo" data-estado="pendiente">👁️</span>
      </div>
      <div>
        <span>📑 Cantidad de Series:</span> ${estudio.num_series || 0}
      </div>
      <div>
        <button class="btn-icon btn-exportar" data-id="${estudio.id}">⬇ Exportar</button>
        <button class="btn-icon" onclick="abrirVisorDesdeTabla(${estudio.id})">✏ Editar</button>
      </div>
      <div>
        <label>👨‍⚕ Médico Remitente:</label>
        <input type="text" value="${estudio.medico || ""}" class="input-medico"/>
      </div>
      <div>
        <button class="btn-icon btn-importar" data-id="${estudio.id}">📄 Importar Informe</button>
        <input type="file" class="file-informe hidden" accept=".pdf,.txt,.docx"/>
      </div>
    </div>

    <!-- Aquí mostramos el QR -->
<div class="mt-3 p-3 bg-white border rounded shadow flex flex-col items-start">
  <p class="font-semibold mb-2">🔗 Acceso rápido</p>
  <div id="qrcode-${estudio.id}" class="mb-2"></div>
  <button onclick="copiarLink('${estudio.id}')"
    class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">
    Copiar enlace
  </button>
</div>

<!-- Aquí mostramos los informes -->
<div id="informes-${estudio.id}" class="informes-panel mt-3"></div>
`;

  // Expansión al hacer click
  tr.addEventListener("click", (e) => {
    if (e.target.classList.contains("btn-ver")) return;
    panel.style.display = panel.style.display === "none" ? "table-row" : "none";
  });

  // Cambiar estado con el 👁️
  panel.querySelector(".icono-ojo").addEventListener("click", (e) => {
    const ojo = e.target;
    const estadoCol = tr.querySelector(".estado-col");
    if (ojo.dataset.estado === "pendiente") {
      ojo.dataset.estado = "visto";
      estadoCol.textContent = "Visto ✅";
    } else {
      ojo.dataset.estado = "pendiente";
      estadoCol.textContent = "Pendiente";
    }
  });

  // === BOTÓN EXPORTAR ===
  panel.querySelector(".btn-exportar").addEventListener("click", async () => {
    const id = estudio.id;
    try {
      const res = await fetch(`${API_BASE}/exportar/${id}`);
      if (!res.ok) throw new Error("Error exportando estudio");
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `estudio_${id}.zip`;
      a.click();
      URL.revokeObjectURL(url);
    } catch (err) {
      alert("No se pudo exportar el estudio");
      console.error(err);
    }
  });

  // === BOTÓN IMPORTAR INFORME ===
  const fileInput = panel.querySelector(".file-informe");
panel.querySelector(".btn-importar").addEventListener("click", () => {
  fileInput.click();
});

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const formData = new FormData();
  formData.append("informe", file);

  try {
    const res = await fetch(`${API_BASE}/importar_informe/${estudio.id}`, {
      method: "POST",
      body: formData
    });
    if (!res.ok) throw new Error("Error subiendo informe");
    const result = await res.json();

    // 📌 Ahora insertamos el informe en el panel justo debajo del QR
    const informesPanel = document.getElementById(`informes-${estudio.id}`);
    const wrapper = document.createElement("div");
    wrapper.classList.add("informe-item");

    if (file.type === "application/pdf") {
      wrapper.innerHTML = `
        <p class="font-bold">📄 ${file.name}</p>
        <iframe src="${API_BASE}/informes/${result.filename}" 
                class="w-full h-64 border rounded"></iframe>
      `;
    } else {
      wrapper.innerHTML = `
        <p class="font-bold">📄 ${file.name}</p>
        <pre class="bg-gray-100 p-2 rounded">${await file.text()}</pre>
      `;
    }

    informesPanel.appendChild(wrapper);
  } catch (err) {
    alert("No se pudo importar el informe");
    console.error(err);
  }
});

  tbody.appendChild(tr);
  tbody.appendChild(panel);
// === GENERAR QR ===
const qrContainer = document.getElementById(`qrcode-${estudio.id}`);
if (qrContainer) {
  new QRCode(qrContainer, {
    text: `${window.location.origin}/estudio/${estudio.id}`, // URL única
    width: 100,
    height: 100,
  });
}
}
async function cargarEstudios() {
  try {
    const res = await fetch(`${API_BASE}/estudios`);
    if (!res.ok) throw new Error("Error al obtener estudios");
    const data = await res.json();

    // Limpiar y guardar en el array global
    estudios.length = 0;
    estudios.push(...data);

    // Renderizar en tabla
    const tbody = document.getElementById("tablaEstudios");
    tbody.innerHTML = "";
    estudios.forEach(e => renderEstudioConExpansion(e));

  } catch (err) {
    console.error(err);
    alert("No se pudo cargar los estudios");
  }
}
function abrirVisorDesdeTabla(estudioId) {
  // buscar el estudio en el array global
  const est = estudios.find(e => e.id === estudioId);
  if (!est) {
    alert("Estudio no encontrado");
    return;
  }

  // abrir directamente el modal de series de ese estudio
  abrirModalSeries(est.id);
}

function actualizarFiltros(){
  const medicoSet = new Set(estudios.map(e=>e.medico_remitente).filter(Boolean));
  const medicoSelect = document.getElementById("filterMedico");
  medicoSelect.innerHTML='<option value="">Todos los Médicos</option>';
  medicoSet.forEach(m=>{
    const opt=document.createElement("option");
    opt.value=m; opt.textContent=m; medicoSelect.appendChild(opt);
  });
}

function aplicarFiltros(){
  const q=(document.getElementById("search").value||"").toLowerCase();
  const estado=document.getElementById("filterEstado").value;
  const medico=document.getElementById("filterMedico").value;
  const numImg=document.getElementById("filterNumImagenes").value;

  estudiosFiltrados = estudios.filter(e=>{
    let match=true;
    if(q && !( (e.nombre||"").toLowerCase().includes(q) || (e.paciente_id||"").toLowerCase().includes(q) || (e.fecha||"").toLowerCase().includes(q) )) match=false;
    if(estado && e.estado!==estado) match=false;
    if(medico && e.medico_remitente!==medico) match=false;
    if(numImg){
      if(numImg==="4" && e.num_imagenes<4) match=false;
      else if(numImg!=="4" && e.num_imagenes!=parseInt(numImg)) match=false;
    }
    return match;
  });
  renderTabla();
}

function renderTabla(){
  const tbody=document.getElementById("tablaEstudios");
  tbody.innerHTML="";
  estudiosFiltrados.forEach(e=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${e.nombre||""}</td>
      <td>${formatFecha(e.created_at)}</td>
      <td>${formatNacimiento(e.nacimiento)}</td>
      <td>${e.descripcion||""}</td>
      <td>${e.paciente_id||""}</td>
      <td>${e.institucion||""}</td>
      <td>${e.num_imagenes||0}</td>
      <td>${e.estado||""}</td>
      <td><button onclick="abrirModalSeries(${e.id})" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Ver</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// abrir modal series
async function abrirModalSeries(estudioId){
  const modal=document.getElementById("modalSeries");
  const cont=document.getElementById("seriesContainer");
  cont.innerHTML="Cargando series...";
  modal.classList.remove("hidden");

  try{
    const res=await fetch(`${API_BASE}/estudios/${estudioId}/series`);
    if(!res.ok) throw new Error("no series");
    const series = await res.json();
    cont.innerHTML="";
    for(const s of series){
     const div=document.createElement("div");
div.className="border p-2 rounded bg-white/70";
div.innerHTML = `
  <div class="flex justify-between items-start mb-2">
    <div>
      <h3 class="font-semibold text-red-600">${s.series_description||s.modality||"Serie"}</h3>
      <div class="text-xs text-gray-600">Médico: ${s.medico_remitente||""} • Imágenes: ${s.num_imagenes||0}</div>
    </div>
    <div>
      <button onclick="abrirDicomViewerConSerie(${s.id})" class="px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700">Editar</button>
    </div>
  </div>
  <div id="imagenes_${s.id}" class="series-scroll"></div>
`;
cont.appendChild(div);
      // cargar imágenes de esta serie
      cargarImagenesSerie(s.id, estudioId, s);
    }
  }catch(err){
    cont.innerHTML="No se pudieron cargar las series";
    console.error(err);
  }
}

function cerrarModalSeries(){
  document.getElementById("modalSeries").classList.add("hidden");
}

/* util de fechas y nacimientos (copiado tal cual de tu código) */
function formatFecha(fechaStr){
  if(!fechaStr) return "";
  const f = new Date(fechaStr);
  if(isNaN(f.getTime())) return fechaStr;
  const dia=("0"+f.getDate()).slice(-2);
  const mes=("0"+(f.getMonth()+1)).slice(-2);
  const anio=f.getFullYear();
  const h=("0"+f.getHours()).slice(-2);
  const m=("0"+f.getMinutes()).slice(-2);
  return `${dia}-${mes}-${anio} - ${h}:${m}`;
}
function formatNacimiento(fechaStr){
  if(!fechaStr) return "";
  const s = String(fechaStr).trim();
  if(/^\d{8}$/.test(s)){
    return `${s.slice(6,8)}-${s.slice(4,6)}-${s.slice(0,4)}`;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    return `${s.slice(8,10)}-${s.slice(5,7)}-${s.slice(0,4)}`;
  }
  if(/^\d{2}-\d{2}-\d{4}$/.test(s)) return s;
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const dia=("0"+d.getDate()).slice(-2);
    const mes=("0"+(d.getMonth()+1)).slice(-2);
    const anio=d.getFullYear();
    return `${dia}-${mes}-${anio}`;
  }
  return s;
}

function cargarMiniaturasEVO(imagenes) {
  const cont = document.getElementById("miniaturasSerie");
  cont.innerHTML = "";
  imagenes.forEach((imgObj, idx) => {
    const div = document.createElement("div");
    div.className = "miniatura-item";
    const src = imgObj.preview_base64 ? 
      `data:image/png;base64,${imgObj.preview_base64}` : 
      `${API_BASE}/imagen/${imgObj.id}?frame=0`;
    div.innerHTML = `<img src="${src}" alt="miniatura" />`;

    div.addEventListener("click", () => {
      mostrarImagenSerie(idx); // cambiar imagen principal

      // Quitar clase active de todas las miniaturas
      const items = cont.querySelectorAll(".miniatura-item");
      items.forEach(i => i.classList.remove("active"));

      // Agregar clase active a la miniatura clickeada
      div.classList.add("active");
    });

    // Por defecto, la primera miniatura activa
    if(idx === 0) div.classList.add("active");

    cont.appendChild(div);
  });
}
// ✅ Exportar estudio en ZIP
async function exportarEstudio() {
  if (!estudioActual) {
    alert("No hay estudio cargado.");
    return;
  }

  const url = `${API_BASE}/exportar/${estudioActual}`;
  try {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Error en la exportación");

    const blob = await res.blob();
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `estudio_${estudioActual}.zip`;
    link.click();
  } catch (err) {
    console.error(err);
    alert("❌ No se pudo exportar el estudio");
  }
}

// ✅ Abrir el input para seleccionar informe
function abrirInputInforme() {
  document.getElementById("inputInforme").click();
}

// ✅ Subir informe
async function importarInforme(event) {
  if (!estudioActual) {
    alert("No hay estudio cargado.");
    return;
  }
  const file = event.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("informe", file);

  try {
    const res = await fetch(`${API_BASE}/importar_informe/${estudioActual}`, {
      method: "POST",
      body: formData
    });
    if (!res.ok) throw new Error("Error al subir el informe");

    await res.json();
    alert("✅ Informe importado");
    cargarInformes(); // refrescar lista
  } catch (err) {
    console.error(err);
    alert("❌ No se pudo importar el informe");
  }
}

// ✅ Cargar informes del estudio y mostrarlos
async function cargarInformes() {
  if (!estudioActual) return;

  try {
    const res = await fetch(`${API_BASE}/informes/${estudioActual}`);
    if (!res.ok) throw new Error("Error al cargar informes");
    const informes = await res.json();

    const area = document.getElementById(`informes-${estudioActual}`);
    area.innerHTML = "";

    if (informes.length === 0) {
      area.innerHTML = "<p>No hay informes.</p>";
      return;
    }

    informes.forEach(fname => {
      const card = document.createElement("div");
      card.className = "bg-gray-100 p-3 rounded shadow mb-2";

      const isPDF = fname.toLowerCase().endsWith(".pdf");

      card.innerHTML = `
        <div class="flex justify-between items-center">
          <span class="font-semibold">📄 ${fname}</span>
          <div>
            <a href="${API_BASE}/informes/${estudioActual}/${fname}" target="_blank" 
               class="px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700">Ver</a>
            <a href="${API_BASE}/informes/${estudioActual}/${fname}" download
               class="px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700">Descargar</a>
          </div>
        </div>
        ${isPDF 
          ? `<iframe src="${API_BASE}/informes/${estudioActual}/${fname}" class="w-full h-64 mt-2 border"></iframe>`
          : `<pre class="bg-white p-2 rounded mt-2 text-sm">${fname}</pre>`}
      `;
      
      area.appendChild(card);
    });
  } catch (err) {
    console.error(err);
  }
}
 
/* Inicial: aplicamos transform para evitar NaN */
applyTransform();

/* ========== PAGINACIÓN ========== */
let page = 0;
const limit = 50;

async function loadStudies() {
  try {
    const res = await fetch(`${API_BASE}/estudios?skip=${page * limit}&limit=${limit}`);
    if (!res.ok) throw new Error("Error al obtener estudios paginados");
    const data = await res.json();

    // Agregar estudios a la tabla
    const tbody = document.getElementById("tablaEstudios");
    data.forEach(e => renderEstudioConExpansion(e));

    // Si hay menos de 'limit', no hay más páginas
    if (data.length < limit) {
      document.getElementById("btnNext").disabled = true;
    } else {
      document.getElementById("btnNext").disabled = false;
    }
  } catch (err) {
    console.error(err);
    alert("Error cargando más estudios");
  }
}

function nextPage() {
  page++;
  loadStudies();
}

function prevPage() {
  if (page > 0) {
    page--;
    loadStudies();
  }
}

</script>
</body>
</html>
